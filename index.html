<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freelance Services By Thukha Aung</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Padauk:wght@400;700&display=swap');
        body { font-family: 'Padauk', sans-serif; }
        
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Editor Styles */
        .editor-page {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            min-height: 800px;
            background: white;
            padding: 40px;
            outline: none;
        }
        .editor-toolbar button {
            padding: 6px;
            border-radius: 4px;
            color: #4b5563;
        }
        .editor-toolbar button:hover { background-color: #f3f4f6; }
        .editor-toolbar button.active { background-color: #e5e7eb; color: #000; }

        /* A4 Paper Styles for Mobile Scaling */
        .paper-container {
            width: 100%;
            overflow: auto;
            display: flex;
            justify-content: center;
            background: #f3f4f6;
            padding: 20px 0;
        }
        .a4-paper {
            width: 210mm;
            min-height: 297mm;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 20mm;
            position: relative;
            /* Ensure fixed layout regardless of screen size */
            flex-shrink: 0; 
            box-sizing: border-box;
        }

        /* Mobile specific scaling for preview */
        @media screen and (max-width: 850px) {
            .paper-scaler {
                transform-origin: top center;
            }
        }

        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            .a4-paper, .a4-paper * { visibility: visible; }
            .a4-paper { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%; 
                margin: 0; 
                padding: 0; 
                box-shadow: none; 
                border: none; 
            }
            @page { size: auto; margin: 12.7mm; } 
            .no-print { display: none !important; }
            .paper-container { padding: 0; background: white; display: block; }
            .paper-scaler { transform: none !important; }
        }
        
        /* Hide scrollbar for tabs */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col justify-center">

    <div class="fixed top-4 right-4 z-50 flex gap-2 no-print">
        <button onclick="app.toggleLang()" class="bg-white border shadow-sm px-3 py-1.5 rounded-full text-sm font-bold hover:bg-gray-50 flex items-center gap-1 transition-transform active:scale-95">
            <span id="lang-icon">ðŸ‡¬ðŸ‡§</span> <span id="lang-text">EN</span>
        </button>
    </div>

    <main class="w-full max-w-6xl mx-auto p-2 md:p-4" id="main-container">
    </main>

    <div id="modal-container"></div>

    <input type="file" id="item-image-input" hidden accept="image/*" onchange="app.processItemImage(this)">
    <input type="file" id="setting-logo-input" hidden accept="image/*" onchange="app.processLogo(this)">
    <input type="file" id="setting-sign-input" hidden accept="image/*" onchange="app.processSign(this)">

    <div id="scanner-modal" class="fixed inset-0 bg-black bg-opacity-90 hidden z-[60] flex flex-col items-center justify-center p-4">
        <div class="bg-white p-4 rounded-xl w-full max-w-md relative">
            <button onclick="app.stopScanner()" class="absolute top-2 right-2 text-gray-500 hover:text-red-500"><i data-lucide="x"></i></button>
            <h3 class="text-center font-bold mb-4" data-translate="scan_qr">Scan QR Code</h3>
            <div id="reader" style="width: 100%;"></div>
        </div>
    </div>

    <!-- TEMPLATES -->
    <template id="tpl-home">
        <div class="flex flex-col items-center justify-center py-4 text-center space-y-6 fade-in min-h-[80vh]">
            <div class="mb-4">
                <div class="bg-blue-600 text-white p-3 rounded-2xl inline-block shadow-lg mb-3">
                    <i data-lucide="file-text" width="32" height="32"></i>
                </div>
                <h1 class="font-bold text-xl text-blue-900">Freelance Services By Thukha Aung</h1>
            </div>
            <h2 class="text-2xl md:text-3xl font-extrabold text-gray-900" data-translate="verify_payment_title">Verify Payment</h2>
            <div class="w-full max-w-md space-y-6">
                <div class="bg-white p-6 rounded-xl shadow border">
                    <label class="block text-left text-sm font-medium text-gray-700 mb-2" data-translate="method_1">Method 1 - Enter Number</label>
                    <div class="flex gap-2">
                        <input type="text" id="search-input" placeholder="INV-xxx / QTN-xxx / CON-xxx" class="flex-1 border px-4 py-2 rounded-lg outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 text-sm">
                        <button onclick="app.handleSearch()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors text-sm" data-translate="check_btn">Check</button>
                    </div>
                </div>
                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-gray-300"></div><span class="flex-shrink-0 mx-4 text-gray-400 text-xs">OR</span><div class="flex-grow border-t border-gray-300"></div>
                </div>
                <button onclick="app.startScanner()" class="w-full bg-gray-800 hover:bg-gray-900 text-white p-5 rounded-xl shadow-lg flex items-center justify-center gap-3 transition-transform hover:scale-[1.02]">
                    <i data-lucide="qr-code" width="28" height="28"></i>
                    <div class="text-left"><div class="font-bold text-base" data-translate="method_2">Method 2 - Scan QR</div><div class="text-xs text-gray-400" data-translate="use_camera">Use Camera</div></div>
                </button>
                <div class="text-center pt-2">
                    <button onclick="app.handleAuthClick()" class="text-[10px] text-gray-300 hover:text-gray-500 underline cursor-pointer transition-colors" data-translate="admin_login_link">Admin Click Here</button>
                </div>
            </div>
        </div>
    </template>

    <template id="tpl-login">
        <div class="max-w-md mx-auto mt-4 bg-white p-8 rounded-2xl shadow-xl border fade-in relative">
            <button onclick="app.setView('home')" class="absolute top-4 left-4 text-gray-400 hover:text-gray-600"><i data-lucide="arrow-left" width="20"></i></button>
            <h2 class="text-2xl font-bold mb-2 text-center text-gray-800" data-translate="admin_login">Admin Login</h2>
            <button onclick="app.googleLogin()" class="w-full mb-6 mt-4 flex items-center justify-center gap-2 bg-white border border-gray-300 text-gray-700 py-2.5 rounded-lg hover:bg-gray-50 font-medium shadow-sm">Sign in with Google</button>
            <div class="relative flex py-2 items-center mb-6"><div class="flex-grow border-t border-gray-300"></div><span class="flex-shrink-0 mx-4 text-gray-400 text-sm">Or with Email</span><div class="flex-grow border-t border-gray-300"></div></div>
            <form onsubmit="app.handleEmailAuth(event)" class="space-y-4">
                <div id="auth-error" class="hidden bg-red-50 text-red-600 text-sm p-3 rounded-lg border border-red-200"></div>
                <input type="email" id="email" class="w-full border px-4 py-2 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="Email" required>
                <input type="password" id="password" class="w-full border px-4 py-2 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="Password" required>
                <button type="submit" class="w-full bg-blue-600 text-white py-2.5 rounded-lg hover:bg-blue-700 font-medium" data-translate="login_btn">Login</button>
            </form>
        </div>
    </template>

    <template id="tpl-dashboard">
        <div class="fade-in">
            <div class="flex justify-between items-center mb-4 pb-2 border-b">
                 <button onclick="app.setView('home')" class="text-gray-500 hover:text-gray-800 flex items-center gap-1 text-sm"><i data-lucide="arrow-left" width="16"></i> <span data-translate="home">Home</span></button>
                 <h2 class="font-bold text-gray-800" data-translate="dashboard">Dashboard</h2>
                 <button onclick="app.logout()" class="text-red-500 hover:text-red-700 text-xs font-medium flex items-center gap-1"><i data-lucide="log-out" width="14"></i> <span data-translate="logout">Logout</span></button>
            </div>

            <div class="flex overflow-x-auto gap-2 mb-6 pb-2 scrollbar-hide">
                <button onclick="app.switchTab('invoice')" id="tab-invoice" class="tab-btn whitespace-nowrap px-4 py-2 rounded-lg text-sm font-medium bg-white border shadow-sm" data-translate="invoices">Invoices</button>
                <button onclick="app.switchTab('quotation')" id="tab-quotation" class="tab-btn whitespace-nowrap px-4 py-2 rounded-lg text-sm font-medium text-gray-500 hover:bg-gray-50" data-translate="quotations">Quotations</button>
                <button onclick="app.switchTab('contract')" id="tab-contract" class="tab-btn whitespace-nowrap px-4 py-2 rounded-lg text-sm font-medium text-gray-500 hover:bg-gray-50" data-translate="contracts">Contracts</button>
                <button onclick="app.switchTab('customer')" id="tab-customer" class="tab-btn whitespace-nowrap px-4 py-2 rounded-lg text-sm font-medium text-gray-500 hover:bg-gray-50" data-translate="customers">Customers</button>
                <button onclick="app.switchTab('expense')" id="tab-expense" class="tab-btn whitespace-nowrap px-4 py-2 rounded-lg text-sm font-medium text-gray-500 hover:bg-gray-50" data-translate="expenses">Expenses</button>
                <button onclick="app.switchTab('report')" id="tab-report" class="tab-btn whitespace-nowrap px-4 py-2 rounded-lg text-sm font-medium text-gray-500 hover:bg-gray-50" data-translate="reports">Reports</button>
                <button onclick="app.setView('settings')" class="whitespace-nowrap px-4 py-2 rounded-lg text-sm font-medium text-gray-500 hover:bg-gray-50"><i data-lucide="settings" width="16" class="inline"></i></button>
            </div>

            <div id="report-filters" class="hidden flex-wrap gap-2 mb-4 items-end bg-gray-100 p-3 rounded-lg border">
                <div>
                    <label class="block text-xs font-medium text-gray-500" data-translate="year">Year</label>
                    <select id="report-year" class="border p-1.5 rounded text-sm w-24"></select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500" data-translate="month">Month</label>
                    <select id="report-month" class="border p-1.5 rounded text-sm w-32">
                        <option value="all">All Months</option>
                        <option value="0">January</option><option value="1">February</option><option value="2">March</option>
                        <option value="3">April</option><option value="4">May</option><option value="5">June</option>
                        <option value="6">July</option><option value="7">August</option><option value="8">September</option>
                        <option value="9">October</option><option value="10">November</option><option value="11">December</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500" data-translate="customer">Customer</label>
                    <select id="report-customer" class="border p-1.5 rounded text-sm w-40">
                        <option value="all">All Customers</option>
                    </select>
                </div>
                <button onclick="app.renderReports()" class="bg-blue-600 text-white px-4 py-1.5 rounded text-sm hover:bg-blue-700" data-translate="filter_btn">Filter</button>
            </div>

            <div id="action-bar" class="flex justify-end mb-4">
                <button onclick="app.handleCreateButtonClick()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-sm text-sm">
                    <i data-lucide="plus" width="16"></i> <span id="create-btn-text">Create New</span>
                </button>
            </div>

            <div class="bg-white rounded-xl shadow overflow-hidden border min-h-[400px]">
                <div id="dashboard-content" class="overflow-x-auto">
                </div>
            </div>
        </div>
    </template>

    <template id="tpl-create">
        <div class="max-w-3xl mx-auto bg-white p-6 rounded-xl shadow-lg border fade-in">
            <div class="flex justify-between items-center mb-6 border-b pb-2">
                <h2 class="text-xl font-bold" id="form-title">Create New</h2>
                <span id="form-mode-badge" class="px-2 py-1 bg-gray-100 text-xs rounded uppercase font-bold text-gray-500">MODE</span>
            </div>
            <form onsubmit="app.handleSave(event)" class="space-y-6">
                <!-- Doc Number Edit -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Document No.</label>
                    <input type="text" id="doc-number" class="w-full border p-2 rounded bg-gray-50 focus:bg-white font-mono uppercase" required>
                </div>

                <div class="relative grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-translate="customer">Customer ID</label>
                        <div class="flex gap-2">
                            <input type="text" id="client-id-input" list="customer-ids" onchange="app.fillCustomerById(this.value)" class="w-full border p-2 rounded uppercase" placeholder="CUST-XXX">
                            <datalist id="customer-ids"></datalist>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-translate="client_name">Client Name</label>
                        <input type="text" id="client-name" list="customer-list" onchange="app.fillCustomerInfo(this.value)" required class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Type name or select...">
                        <datalist id="customer-list"></datalist>
                    </div>
                    
                    <input type="hidden" id="client-db-id">
                    <input type="hidden" id="client-email-hidden">
                    <input type="hidden" id="client-phone-hidden">
                    <input type="hidden" id="client-address-hidden">
                </div>
                <div id="client-details" class="text-xs text-gray-500 mt-1 hidden p-2 bg-gray-50 rounded border">
                    <span id="client-phone"></span> | <span id="client-address"></span>
                </div>

                <div id="items-container">
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="items">Items</label>
                </div>
                <button type="button" onclick="app.addItem()" class="text-sm text-blue-600 font-medium flex items-center gap-1"><i data-lucide="plus"></i> <span data-translate="add_item">Add Item</span></button>

                <div class="border-t pt-4 bg-gray-50 p-4 rounded-lg">
                    <div class="flex justify-between items-center mb-2"><span class="text-gray-600" data-translate="subtotal">Subtotal:</span><span class="font-medium" id="subtotal-display">0</span></div>
                    <div class="flex justify-between items-center mb-2"><span class="text-gray-600" data-translate="discount">Discount (Ks):</span><input type="number" id="discount-input" value="0" min="0" class="border p-1 w-32 text-right rounded" onchange="app.updateCalc(this.value, 'discount')"></div>
                    <div class="flex justify-between items-center mb-4"><span class="text-gray-600">Tax (%):</span><input type="number" id="tax-input" value="0" min="0" step="0.1" class="border p-1 w-32 text-right rounded" onchange="app.updateCalc(this.value, 'tax')"></div>
                    
                    <div class="flex justify-between items-center text-lg font-bold text-gray-800 mb-4 border-t border-gray-200 pt-2"><span data-translate="total">Total:</span><span><span id="create-total">0</span> Ks</span></div>
                    <div id="invoice-payment-section">
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center gap-2"><span class="text-blue-700 font-medium" data-translate="deposit">Payment / Deposit:</span>
                            <select id="init-payment-method" class="text-sm border rounded p-1 payment-method-select"></select>
                            </div>
                            <input type="number" id="init-payment-input" value="0" min="0" class="border p-1 w-32 text-right rounded border-blue-300 focus:ring-2 focus:ring-blue-200" onchange="app.updateCalc(this.value, 'payment')">
                        </div>
                        <div class="flex justify-between items-center text-red-600 font-bold border-t border-gray-200 pt-2"><span data-translate="balance">Balance:</span><span><span id="create-balance">0</span> Ks</span></div>
                    </div>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="app.setView('dashboard')" class="px-4 py-2 text-gray-600 bg-gray-100 rounded hover:bg-gray-200" data-translate="cancel">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" data-translate="save">Save</button>
                </div>
            </form>
        </div>
    </template>

    <template id="tpl-contract-edit">
        <div class="max-w-4xl mx-auto bg-gray-100 min-h-screen p-4 fade-in">
             <div class="flex justify-between items-center mb-4 bg-white p-3 rounded-lg shadow-sm">
                <div class="flex items-center gap-4">
                    <button onclick="app.setView('dashboard')" class="text-gray-500 hover:text-gray-800"><i data-lucide="arrow-left"></i></button>
                    <h2 class="font-bold text-lg" data-translate="edit_contract">Contract Editor</h2>
                </div>
                <div class="flex gap-2">
                    <button onclick="app.saveContract()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 font-medium text-sm" data-translate="save">Save Contract</button>
                </div>
             </div>

             <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                 <input type="text" id="contract-title" placeholder="Contract Title" class="border p-2 rounded shadow-sm w-full md:col-span-3" required>
                 
                 <!-- Contract Doc ID -->
                 <input type="text" id="contract-doc-number" placeholder="Contract No." class="border p-2 rounded shadow-sm w-full font-mono uppercase" required>

                 <div class="md:col-span-2 grid grid-cols-2 gap-2">
                    <input type="text" id="contract-client-id" list="customer-ids" onchange="app.fillCustomerById(this.value)" placeholder="Cust ID" class="border p-2 rounded shadow-sm w-full uppercase">
                    <input type="text" id="contract-client" list="customer-list" onchange="app.fillCustomerInfo(this.value)" placeholder="Client Name" class="border p-2 rounded shadow-sm w-full" required>
                 </div>
                 
                 <input type="hidden" id="client-db-id">
                 <input type="hidden" id="client-email-hidden">
                 <input type="hidden" id="client-phone-hidden">
                 <input type="hidden" id="client-address-hidden">
             </div>

             <!-- Rich Text Toolbar -->
             <div class="bg-white p-2 rounded-t-lg border-b sticky top-0 z-10 editor-toolbar flex flex-wrap gap-1 shadow-sm">
                 <button onclick="app.execCmd('bold')" title="Bold"><i data-lucide="bold" width="16"></i></button>
                 <button onclick="app.execCmd('italic')" title="Italic"><i data-lucide="italic" width="16"></i></button>
                 <button onclick="app.execCmd('underline')" title="Underline"><i data-lucide="underline" width="16"></i></button>
                 <div class="w-px h-6 bg-gray-300 mx-1"></div>
                 <button onclick="app.execCmd('justifyLeft')" title="Left"><i data-lucide="align-left" width="16"></i></button>
                 <button onclick="app.execCmd('justifyCenter')" title="Center"><i data-lucide="align-center" width="16"></i></button>
                 <button onclick="app.execCmd('justifyRight')" title="Right"><i data-lucide="align-right" width="16"></i></button>
                 <button onclick="app.execCmd('justifyFull')" title="Justify"><i data-lucide="align-justify" width="16"></i></button>
                 <div class="w-px h-6 bg-gray-300 mx-1"></div>
                 <button onclick="app.execCmd('insertUnorderedList')" title="Bullet List"><i data-lucide="list" width="16"></i></button>
                 <button onclick="app.execCmd('insertOrderedList')" title="Number List"><i data-lucide="list-ordered" width="16"></i></button>
                 <div class="w-px h-6 bg-gray-300 mx-1"></div>
                 <button onclick="app.execCmd('formatBlock', 'h2')" title="Heading"><i data-lucide="heading" width="16"></i></button>
                 <button onclick="app.execCmd('formatBlock', 'p')" title="Paragraph"><i data-lucide="pilcrow" width="16"></i></button>
             </div>

             <!-- Editor Area -->
             <div id="contract-editor" contenteditable="true" class="editor-page" placeholder="Type your contract here..."></div>
        </div>
    </template>

    <template id="tpl-customer-form">
        <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 fade-in">
            <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-md">
                <h3 class="text-lg font-bold mb-4" id="cust-form-title" data-translate="add_customer">Add Customer</h3>
                <form onsubmit="app.saveCustomer(event)" class="space-y-3">
                    <input type="hidden" id="cust-id">
                    <div class="flex gap-2">
                        <input type="text" id="cust-display-id" placeholder="ID (Auto)" readonly class="w-1/3 border p-2 rounded bg-gray-100 text-gray-500">
                        <input type="text" id="cust-name" placeholder="Name" required class="w-2/3 border p-2 rounded">
                    </div>
                    <input type="text" id="cust-phone" placeholder="Phone" class="w-full border p-2 rounded">
                    <input type="email" id="cust-email" placeholder="Email" class="w-full border p-2 rounded">
                    <input type="text" id="cust-address" placeholder="Address" class="w-full border p-2 rounded">
                    <div class="flex justify-end gap-2 mt-4">
                        <button type="button" onclick="app.closeModal()" class="px-4 py-2 bg-gray-100 rounded" data-translate="cancel">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded" data-translate="save">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </template>

    <template id="tpl-expense-form">
        <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 fade-in">
            <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-md">
                <h3 class="text-lg font-bold mb-4" id="exp-form-title" data-translate="add_expense">Add Expense</h3>
                <form onsubmit="app.saveExpense(event)" class="space-y-3">
                    <input type="hidden" id="exp-id">
                    <input type="text" id="exp-title" placeholder="Description (e.g. Lunch)" required class="w-full border p-2 rounded">
                    <div class="flex gap-2">
                        <input type="number" id="exp-amount" placeholder="Amount" required class="w-full border p-2 rounded">
                        <select id="exp-method" class="border p-2 rounded bg-white payment-method-select">
                        </select>
                    </div>
                    <input type="date" id="exp-date" required class="w-full border p-2 rounded">
                    <div class="flex justify-end gap-2 mt-4">
                        <button type="button" onclick="app.closeModal()" class="px-4 py-2 bg-gray-100 rounded" data-translate="cancel">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded" data-translate="save">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </template>

    <template id="tpl-settings">
        <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-lg border fade-in">
            <div class="flex justify-between items-center mb-6 border-b pb-2">
                <h2 class="text-xl font-bold" data-translate="settings">Admin Settings</h2>
                <button onclick="app.setView('dashboard')" class="text-gray-500"><i data-lucide="x"></i></button>
            </div>
            
            <form onsubmit="app.handleSaveSettings(event)" class="space-y-6">
                <!-- Business Info -->
                <div class="p-4 bg-gray-50 rounded-lg border space-y-4">
                    <h3 class="font-bold text-gray-700">Business Information</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-xs font-medium mb-1">Address</label><input type="text" id="setting-biz-address" class="w-full border p-2 rounded text-sm"></div>
                        <div><label class="block text-xs font-medium mb-1">Phone</label><input type="text" id="setting-biz-phone" class="w-full border p-2 rounded text-sm"></div>
                        <div><label class="block text-xs font-medium mb-1">Website</label><input type="text" id="setting-biz-web" class="w-full border p-2 rounded text-sm"></div>
                        <div><label class="block text-xs font-medium mb-1">Email</label><input type="text" id="setting-biz-email" class="w-full border p-2 rounded text-sm"></div>
                        <div><label class="block text-xs font-medium mb-1">Default Tax (%)</label><input type="number" step="0.1" id="setting-tax" class="w-full border p-2 rounded text-sm"></div>
                    </div>
                </div>

                <!-- Logo & Sign -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                     <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="logo">Company Logo</label>
                        <div class="flex items-center gap-4">
                            <div id="logo-preview" class="w-32 h-20 border rounded bg-gray-50 flex items-center justify-center overflow-hidden"><span class="text-xs text-gray-400">No Logo</span></div>
                            <button type="button" onclick="document.getElementById('setting-logo-input').click()" class="px-4 py-2 bg-gray-100 rounded text-sm border" data-translate="change_logo">Change Logo</button>
                        </div>
                    </div>
                    <div>
                         <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="auth_sign">Auth Signature</label>
                         <div class="flex items-center gap-4">
                            <div id="sign-preview" class="w-32 h-20 border rounded bg-white flex items-center justify-center overflow-hidden"><span class="text-xs text-gray-400">No Sign</span></div>
                            <button type="button" onclick="document.getElementById('setting-sign-input').click()" class="px-4 py-2 bg-white border rounded text-sm shadow-sm" data-translate="upload">Upload</button>
                        </div>
                    </div>
                </div>

                <!-- Payment Methods Manager -->
                <div class="p-4 bg-gray-50 rounded-lg border">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-gray-700">Payment Methods</h3>
                        <button type="button" onclick="app.addPaymentMethod()" class="text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700">+ Add New</button>
                    </div>
                    <div id="payment-methods-list" class="space-y-2">
                        <!-- Methods list injected here -->
                    </div>
                    <div id="payment-method-form" class="hidden mt-3 p-3 bg-white border rounded shadow-sm">
                        <input type="text" id="new-method-name" placeholder="Method Name (e.g. KBZ Pay)" class="w-full border p-2 rounded text-sm mb-2">
                        <div class="flex justify-end gap-2">
                            <button type="button" onclick="document.getElementById('payment-method-form').classList.add('hidden')" class="text-xs text-gray-500">Cancel</button>
                            <button type="button" onclick="app.savePaymentMethod()" class="text-xs bg-green-600 text-white px-3 py-1 rounded">Save</button>
                        </div>
                    </div>
                </div>

                <!-- General Settings -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2" data-translate="auth_name">Auth Person Name</label><input type="text" id="setting-auth-name" class="w-full border p-2 rounded"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1" data-translate="payment_accounts">General Payment Info (Footer)</label><textarea id="setting-accounts" rows="3" class="w-full border p-2 rounded" placeholder="Bank details to show on invoice footer..."></textarea></div>
                </div>
                <div><label class="block text-sm font-medium text-gray-700 mb-1" data-translate="terms">Terms / Note</label><textarea id="setting-terms" rows="2" class="w-full border p-2 rounded"></textarea></div>
                <div class="flex justify-end gap-3 pt-4"><button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded" data-translate="save_settings">Save Settings</button></div>
            </form>
        </div>
    </template>

    <template id="tpl-verify">
        <div class="flex flex-col items-center fade-in bg-gray-100 min-h-screen">
            <div class="w-full max-w-4xl mb-4 flex justify-between no-print relative z-[100] p-4">
                <button onclick="app.backHome()" class="flex items-center gap-2 text-gray-600 hover:text-gray-900 bg-white px-3 py-1 rounded shadow-sm border">
                    <i data-lucide="arrow-left"></i> <span data-translate="back">Back</span>
                </button>
                <div class="flex gap-2">
                    <button onclick="window.print()" class="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow hover:bg-blue-700 cursor-pointer relative z-[101]">
                        <i data-lucide="printer"></i> <span data-translate="print">Print</span>
                    </button>
                    <button onclick="app.downloadPDF()" class="bg-gray-800 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-gray-900 cursor-pointer relative z-[101]">
                        <i data-lucide="download"></i> PDF
                    </button>
                </div>
            </div>
            <!-- Scalable A4 Container -->
            <div id="verify-content" class="paper-container"></div>
        </div>
    </template>

    <template id="tpl-payment-modal">
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 fade-in">
            <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-sm">
                <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold" id="payment-modal-title" data-translate="add_payment">Add Payment</h3><button onclick="app.closeModal()" class="text-gray-400"><i data-lucide="x"></i></button></div>
                <div class="bg-gray-50 p-3 rounded-lg mb-4 space-y-1">
                    <div class="flex justify-between text-sm"><span data-translate="total">Total:</span><span id="modal-total" class="font-medium">0</span></div>
                    <div class="flex justify-between text-sm text-green-600"><span data-translate="paid">Paid:</span><span id="modal-paid" class="font-medium">0</span></div>
                    <div class="flex justify-between text-sm font-bold text-red-600 border-t pt-1"><span data-translate="balance">Balance:</span><span id="modal-balance">0</span></div>
                </div>
                <div class="space-y-4">
                    <input type="number" id="payment-amount" class="w-full border p-2 rounded font-bold">
                    <select id="payment-method-select" class="w-full border p-2 rounded payment-method-select"></select>
                </div>
                <div class="flex justify-end gap-2 mt-6"><button onclick="app.closeModal()" class="px-4 py-2 bg-gray-100 rounded" data-translate="cancel">Cancel</button><button onclick="app.confirmPayment()" class="px-4 py-2 bg-green-600 text-white rounded" data-translate="confirm">Confirm</button></div>
            </div>
        </div>
    </template>

    <template id="tpl-invoice-option">
        <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 fade-in">
            <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-md">
                <div class="flex justify-between items-center mb-6"><h3 class="text-lg font-bold" data-translate="create_invoice">Create Invoice</h3><button onclick="app.closeModal()"><i data-lucide="x"></i></button></div>
                <div class="space-y-4">
                    <button onclick="app.createManualInvoice()" class="w-full flex items-center gap-4 p-4 border rounded-xl hover:bg-blue-50">
                        <div class="bg-blue-100 p-3 rounded-full text-blue-600"><i data-lucide="file-plus"></i></div>
                        <div class="text-left"><div class="font-bold" data-translate="manual_invoice">Manual Invoice</div><div class="text-xs text-gray-500">Blank invoice</div></div>
                    </button>
                    <div class="relative flex py-2 items-center"><div class="flex-grow border-t"></div><span class="flex-shrink-0 mx-4 text-xs uppercase text-gray-400">OR</span><div class="flex-grow border-t"></div></div>
                    <div class="p-4 border rounded-xl bg-gray-50">
                        <div class="flex items-center gap-2 mb-3"><div class="bg-purple-100 p-2 rounded-full text-purple-600"><i data-lucide="file-text" width="16"></i></div><div class="font-bold text-sm" data-translate="from_quotation">From Quotation</div></div>
                        <div class="flex gap-2"><input type="text" id="qtn-import-input" placeholder="QTN-123" class="flex-1 border text-sm p-2 rounded uppercase"><button onclick="app.importQuotation()" class="bg-purple-600 text-white px-4 py-2 rounded text-sm" data-translate="load">Load</button></div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, doc, deleteDoc, setDoc, getDoc, onSnapshot, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBz5Cm-qsKe9pshGLaBkzw0WTOg9OLDwHk",
            authDomain: "invoice-99bdb.firebaseapp.com",
            projectId: "invoice-99bdb",
            storageBucket: "invoice-99bdb.firebasestorage.app",
            messagingSenderId: "1055209115726",
            appId: "1:1055209115726:web:926791697e6ad783e5b31f"
        };

        const appInstance = initializeApp(firebaseConfig);
        const auth = getAuth(appInstance);
        const db = getFirestore(appInstance);

        // --- TRANSLATION RESOURCES ---
        const resources = {
            en: {
                verify_payment_title: "Verify Payment",
                method_1: "Method 1 - Enter Number",
                method_2: "Method 2 - Scan QR Code",
                use_camera: "Use Camera to Scan",
                admin_login_link: "Admin Click Here",
                check_btn: "Check",
                scan_qr: "Scan QR Code",
                admin_login: "Admin Login",
                login_btn: "Login",
                home: "Home",
                dashboard: "Dashboard",
                logout: "Logout",
                invoices: "Invoices",
                quotations: "Quotations",
                contracts: "Contracts",
                customers: "Customers",
                expenses: "Expenses",
                reports: "Reports",
                settings: "Settings",
                year: "Year",
                month: "Month",
                customer: "Customer",
                filter_btn: "Filter",
                create_new: "Create New",
                client_name: "Client Name",
                items: "Items",
                add_item: "Add Item",
                subtotal: "Subtotal:",
                discount: "Discount (Ks):",
                total: "Total:",
                deposit: "Payment / Deposit:",
                balance: "Balance:",
                cancel: "Cancel",
                save: "Save",
                add_customer: "Add Customer",
                add_expense: "Add Expense",
                logo: "Company Logo",
                change_logo: "Change Logo",
                auth_name: "Auth Person Name",
                auth_sign: "Auth Signature",
                upload: "Upload",
                payment_accounts: "Payment Footer Info",
                terms: "Terms / Note",
                save_settings: "Save Settings",
                back: "Back",
                print: "Print",
                add_payment: "Add Payment",
                paid: "Paid:",
                confirm: "Confirm",
                create_invoice: "Create Invoice",
                manual_invoice: "Manual Invoice",
                from_quotation: "From Quotation",
                load: "Load",
                edit_contract: "Contract Editor",
                
                // Dynamic strings
                financial_overview: "Financial Overview",
                income: "Income",
                expense_label: "Expenses",
                net_profit: "Net Profit",
                receivable: "Receivable",
                method_breakdown: "Method Breakdown",
                quotation_stats: "Quotation Stats",
                total_created: "Total Created",
                converted: "Converted to Invoices",
                bill_to: "Bill To:",
                date: "Date:",
                payment_history: "Payment History",
                payment_info: "Payment Info:",
                terms_conditions: "Terms & Conditions:",
                system_generated: "This invoice is system generated and is valid without a seal.",
                authorized_signature: "Authorized Signature",
                desc: "Description",
                qty: "Qty",
                price: "Price",
                no: "No."
            },
            my: {
                verify_payment_title: "á€„á€½á€±á€•á€±á€¸á€á€»á€±á€™á€¾á€¯ á€…á€…á€ºá€†á€±á€¸á€›á€”á€º",
                method_1: "á€”á€Šá€ºá€¸á€œá€™á€ºá€¸ (á) - á€”á€¶á€•á€«á€á€ºá€›á€­á€¯á€€á€ºá€‘á€Šá€·á€ºá€›á€”á€º",
                method_2: "á€”á€Šá€ºá€¸á€œá€™á€ºá€¸ (á‚) - QR Code á€–á€á€ºá€›á€”á€º",
                use_camera: "á€€á€„á€ºá€™á€›á€¬á€¡á€žá€¯á€¶á€¸á€•á€¼á€¯á á€…á€…á€ºá€†á€±á€¸á€•á€«",
                admin_login_link: "Admin á€á€„á€ºá€›á€”á€º á€”á€¾á€­á€•á€ºá€•á€«",
                check_btn: "á€…á€…á€ºá€†á€±á€¸á€™á€Šá€º",
                scan_qr: "QR Code á€–á€á€ºá€›á€”á€º",
                admin_login: "Admin á€á€„á€ºá€›á€±á€¬á€€á€ºá€›á€”á€º",
                login_btn: "á€á€„á€ºá€›á€±á€¬á€€á€ºá€™á€Šá€º",
                home: "á€™á€°á€œá€…á€¬á€™á€»á€€á€ºá€”á€¾á€¬",
                dashboard: "á€’á€€á€ºá€›á€¾á€ºá€˜á€¯á€á€º",
                logout: "á€‘á€½á€€á€ºá€™á€Šá€º",
                invoices: "á€¡á€„á€ºá€—á€½á€­á€¯á€€á€ºá€™á€»á€¬á€¸",
                quotations: "á€€á€­á€¯á€á€±á€¸á€›á€¾á€„á€ºá€¸á€™á€»á€¬á€¸",
                contracts: "á€…á€¬á€á€»á€¯á€•á€ºá€™á€»á€¬á€¸",
                customers: "á€–á€±á€¬á€€á€ºá€žá€Šá€ºá€™á€»á€¬á€¸",
                expenses: "á€€á€¯á€”á€ºá€€á€»á€…á€›á€­á€á€ºá€™á€»á€¬á€¸",
                reports: "á€…á€¬á€›á€„á€ºá€¸á€á€»á€¯á€•á€º",
                settings: "á€†á€€á€ºá€á€„á€ºá€™á€»á€¬á€¸",
                year: "á€á€¯á€”á€¾á€…á€º",
                month: "á€œ",
                customer: "á€–á€±á€¬á€€á€ºá€žá€Šá€º",
                filter_btn: "á€€á€¼á€Šá€·á€ºá€™á€Šá€º",
                create_new: "á€¡á€žá€…á€ºá€–á€”á€ºá€á€®á€¸á€™á€Šá€º",
                client_name: "á€–á€±á€¬á€€á€ºá€žá€Šá€º á€¡á€™á€Šá€º",
                items: "á€•á€…á€¹á€…á€Šá€ºá€¸á€…á€¬á€›á€„á€ºá€¸",
                add_item: "á€•á€…á€¹á€…á€Šá€ºá€¸á€‘á€•á€ºá€‘á€Šá€·á€ºá€™á€Šá€º",
                subtotal: "á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ (á€œá€»á€±á€¬á€·á€…á€»á€±á€¸á€™á€•á€«):",
                discount: "á€œá€»á€±á€¬á€·á€…á€»á€±á€¸ (á€€á€»á€•á€º):",
                total: "á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸:",
                deposit: "á€…á€›á€”á€º / á€•á€±á€¸á€á€»á€±á€„á€½á€±:",
                balance: "á€€á€»á€”á€ºá€„á€½á€±:",
                cancel: "á€™á€œá€¯á€•á€ºá€á€±á€¬á€·á€•á€«",
                save: "á€žá€­á€™á€ºá€¸á€™á€Šá€º",
                add_customer: "á€–á€±á€¬á€€á€ºá€žá€Šá€ºá€¡á€žá€…á€ºá€‘á€Šá€·á€ºá€›á€”á€º",
                add_expense: "á€…á€›á€­á€á€ºá€…á€¬á€›á€„á€ºá€¸á€žá€½á€„á€ºá€¸á€›á€”á€º",
                logo: "á€œá€¯á€•á€ºá€„á€”á€ºá€¸á€œá€­á€¯á€‚á€­á€¯",
                change_logo: "á€œá€­á€¯á€‚á€­á€¯á€•á€¼á€±á€¬á€„á€ºá€¸á€™á€Šá€º",
                auth_name: "á€á€¬á€á€”á€ºá€á€¶ á€¡á€™á€Šá€º",
                auth_sign: "á€œá€€á€ºá€™á€¾á€á€º",
                upload: "á€á€„á€ºá€™á€Šá€º",
                payment_accounts: "á€„á€½á€±á€œá€½á€¾á€²á€›á€”á€º á€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€»á€¬á€¸ (á€¡á€±á€¬á€€á€ºá€á€¼á€±)",
                terms: "á€…á€Šá€ºá€¸á€€á€™á€ºá€¸á€á€»á€€á€º / á€™á€¾á€á€ºá€á€»á€€á€º",
                save_settings: "á€†á€€á€ºá€á€„á€ºá€žá€­á€™á€ºá€¸á€™á€Šá€º",
                back: "á€”á€±á€¬á€€á€ºá€žá€­á€¯á€·",
                print: "á€•á€›á€„á€·á€ºá€‘á€¯á€á€ºá€™á€Šá€º",
                add_payment: "á€„á€½á€±á€œá€€á€ºá€á€¶á€™á€Šá€º",
                paid: "á€•á€±á€¸á€á€»á€±á€•á€¼á€®á€¸:",
                confirm: "á€¡á€á€Šá€ºá€•á€¼á€¯á€™á€Šá€º",
                create_invoice: "Invoice á€–á€½á€„á€·á€ºá€™á€Šá€º",
                manual_invoice: "Manual Invoice á€–á€½á€„á€·á€ºá€™á€Šá€º",
                from_quotation: "Quotation á€™á€¾ á€•á€¼á€±á€¬á€„á€ºá€¸á€™á€Šá€º",
                load: "á€›á€¾á€¬á€–á€½á€±á€™á€Šá€º",
                edit_contract: "á€…á€¬á€á€»á€¯á€•á€ºá€›á€±á€¸á€žá€¬á€¸á€›á€”á€º",

                // Dynamic strings
                financial_overview: "á€˜á€á€¹á€á€¬á€›á€±á€¸ á€žá€¯á€¶á€¸á€žá€•á€ºá€á€»á€€á€º",
                income: "á€á€„á€ºá€„á€½á€±",
                expense_label: "á€‘á€½á€€á€ºá€„á€½á€± (á€…á€›á€­á€á€º)",
                net_profit: "á€¡á€žá€¬á€¸á€á€„á€ºá€¡á€™á€¼á€á€º",
                receivable: "á€›á€›á€”á€ºá€›á€¾á€­ (á€€á€¼á€½á€±á€¸á€€á€»á€”á€º)",
                method_breakdown: "á€„á€½á€±á€•á€±á€¸á€á€»á€±á€™á€¾á€¯á€•á€¯á€¶á€…á€¶ á€á€½á€²á€á€¼á€™á€ºá€¸á€…á€­á€á€ºá€–á€¼á€¬á€á€¼á€„á€ºá€¸",
                quotation_stats: "Quotation á€¡á€á€¼á€±á€¡á€”á€±",
                total_created: "á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ á€¡á€›á€±á€¡á€á€½á€€á€º",
                converted: "Invoice á€•á€¼á€±á€¬á€„á€ºá€¸á€•á€¼á€®á€¸",
                bill_to: "á€á€šá€ºá€šá€°á€žá€° á€¡á€™á€Šá€º:",
                date: "á€›á€€á€ºá€…á€½á€²:",
                payment_history: "á€•á€±á€¸á€á€»á€±á€™á€¾á€¯ á€™á€¾á€á€ºá€á€™á€ºá€¸",
                payment_info: "á€„á€½á€±á€•á€±á€¸á€á€»á€±á€›á€”á€º:",
                terms_conditions: "á€…á€Šá€ºá€¸á€€á€™á€ºá€¸á€á€»á€€á€ºá€™á€»á€¬á€¸:",
                system_generated: "á€¤á€˜á€±á€¬á€€á€ºá€á€»á€¬á€žá€Šá€º á€…á€”á€…á€ºá€™á€¾ á€¡á€œá€­á€¯á€¡á€œá€»á€±á€¬á€€á€º á€‘á€¯á€á€ºá€‘á€¬á€¸á€á€¼á€„á€ºá€¸á€–á€¼á€…á€ºá á€á€¶á€†á€­á€•á€ºá€á€¯á€¶á€¸á€™á€•á€«á€˜á€² á€¡á€á€Šá€ºá€–á€¼á€…á€ºá€žá€Šá€ºá‹",
                authorized_signature: "á€á€¬á€á€”á€ºá€á€¶ á€œá€€á€ºá€™á€¾á€á€º",
                desc: "á€¡á€™á€»á€­á€¯á€¸á€¡á€™á€Šá€º",
                qty: "á€¡á€›á€±á€¡á€á€½á€€á€º",
                price: "á€ˆá€±á€¸á€”á€¾á€¯á€”á€ºá€¸",
                no: "á€…á€‰á€º"
            }
        };

        const state = {
            user: null, isAdmin: false, view: 'home', activeTab: 'invoice', mode: 'invoice',
            invoices: [], quotations: [], customers: [], expenses: [], contracts: [], payment_methods: [],
            currentDoc: null, items: [{desc: '', price: 0, qty: 1, image: null}],
            discount: 0, taxRate: 0, initPayment: 0, tempInvoice: null, html5QrCode: null, editingId: null,
            unlockPassword: '1234', uploadingRowIndex: null,
            settings: { logo: null, accounts: '', terms: '', authName: '', authSign: null, bizAddress: '', bizPhone: '', bizWeb: '', bizEmail: '', taxRate: 0 },
            lang: localStorage.getItem('appLang') || 'en',
            defaultMethods: [{name: 'Cash'}, {name: 'KPay'}, {name: 'Wave'}, {name: 'Bank'}]
        };

        const app = {
            init: () => {
                app.updateLangButton();
                onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        state.user = u; state.isAdmin = !u.isAnonymous;
                        if(state.isAdmin) {
                            app.listenCollection('invoices');
                            app.listenCollection('quotations');
                            app.listenCollection('customers');
                            app.listenCollection('expenses');
                            app.listenCollection('contracts');
                            app.listenCollection('payment_methods');
                        }
                    } else { try { await signInAnonymously(auth); } catch(e){} }
                    
                    const params = new URLSearchParams(window.location.search);
                    if(params.get('id') || params.get('code')) app.handleSearch(params.get('code') || params.get('id'));
                    else app.setView('home');
                });
                app.listenSettings();
                lucide.createIcons();
                // A4 Scaler for mobile
                window.addEventListener('resize', app.scalePaper);
            },

            // --- A4 Scaling Logic ---
            scalePaper: () => {
                const paper = document.querySelector('.a4-paper');
                const container = document.querySelector('.paper-container');
                if (paper && container) {
                    const margin = 20; // 20px padding
                    const parentWidth = container.clientWidth - (margin * 2);
                    const paperWidth = paper.clientWidth; // Should be ~794px (210mm)
                    
                    if (parentWidth < paperWidth) {
                        const scale = parentWidth / paperWidth;
                        paper.style.transform = `scale(${scale})`;
                        paper.classList.add('paper-scaler');
                        // Adjust height of container because scaling doesn't affect flow layout
                        const scaledHeight = paper.offsetHeight * scale;
                        container.style.height = (scaledHeight + 50) + 'px'; // + buffer
                    } else {
                        paper.style.transform = 'none';
                        paper.classList.remove('paper-scaler');
                        container.style.height = 'auto';
                    }
                }
            },

            // --- Translation Logic ---
            t: (key) => resources[state.lang][key] || key,
            toggleLang: () => {
                state.lang = state.lang === 'en' ? 'my' : 'en';
                localStorage.setItem('appLang', state.lang);
                app.updateLangButton();
                app.setView(state.view);
            },
            updateLangButton: () => {
                const icon = document.getElementById('lang-icon');
                const text = document.getElementById('lang-text');
                if(icon && text) {
                    icon.innerText = state.lang === 'en' ? 'ðŸ‡¬ðŸ‡§' : 'ðŸ‡²ðŸ‡²';
                    text.innerText = state.lang === 'en' ? 'EN' : 'MY';
                }
            },
            translatePage: () => {
                document.querySelectorAll('[data-translate]').forEach(el => {
                    const key = el.getAttribute('data-translate');
                    el.innerText = app.t(key);
                });
            },

            // --- Database Listeners ---
            listenCollection: (coll) => {
                onSnapshot(collection(db, coll), (snapshot) => {
                    state[coll] = snapshot.docs.map(doc => ({id: doc.id, ...doc.data(), type: coll.slice(0,-1)}));
                    // Sort descending by created/date
                    if (coll !== 'payment_methods') {
                        state[coll].sort((a,b) => {
                            const tA = a.createdAt?.seconds || new Date(a.date).getTime()/1000 || 0;
                            const tB = b.createdAt?.seconds || new Date(b.date).getTime()/1000 || 0;
                            return tB - tA;
                        });
                    }
                    if(state.view === 'dashboard' && state.activeTab === coll.slice(0,-1)) app.switchTab(state.activeTab);
                    if(state.view === 'dashboard' && state.activeTab === 'report') app.renderReports();
                    if(coll === 'payment_methods' && state.view === 'settings') app.renderPaymentMethods();
                });
            },

            listenSettings: () => {
                onSnapshot(doc(db, 'invoices', 'config_general'), (doc) => {
                    if (doc.exists()) {
                        state.settings = doc.data();
                        if (state.view === 'verify' && state.currentDoc) app.renderPaper(state.currentDoc);
                    }
                });
            },

            // --- Views & Navigation ---
            setView: (viewName) => {
                state.view = viewName;
                const main = document.getElementById('main-container');
                const tpl = document.getElementById(`tpl-${viewName}`);
                if((viewName === 'dashboard' || viewName === 'settings' || viewName === 'contract-edit') && !state.isAdmin) return app.setView('login');
                main.innerHTML = ''; main.appendChild(tpl.content.cloneNode(true));
                
                app.translatePage();
                app.updateLangButton();
                lucide.createIcons();

                if(viewName === 'dashboard') app.switchTab(state.activeTab);
                if(viewName === 'settings') app.initSettingsView();
                if(viewName === 'create') app.initCreateForm();
                if(viewName === 'contract-edit') app.initContractEditor();
                if(viewName === 'verify') setTimeout(app.scalePaper, 100);
            },

            // --- Contract Feature ---
            initContractEditor: () => {
                const titleInput = document.getElementById('contract-title');
                const docNumInput = document.getElementById('contract-doc-number');
                const clientInput = document.getElementById('contract-client');
                const clientIdInput = document.getElementById('contract-client-id');
                const editor = document.getElementById('contract-editor');
                
                const dl = document.getElementById('customer-list');
                const dlIds = document.getElementById('customer-ids'); // ID datalist
                dl.innerHTML = state.customers.map(c => `<option value="${c.name}">${c.phone || ''}</option>`).join('');
                if(dlIds) dlIds.innerHTML = state.customers.map(c => `<option value="${c.customerId}">${c.name}</option>`).join('');

                if(state.editingId) {
                    const c = state.contracts.find(i => i.id === state.editingId);
                    if(c) {
                        titleInput.value = c.title || '';
                        docNumInput.value = c.quotationNumber || '';
                        clientInput.value = c.clientName || '';
                        // Find customer ID based on name if not saved directly
                        const cust = state.customers.find(x => x.name === c.clientName);
                        clientIdInput.value = cust ? cust.customerId : '';
                        
                        editor.innerHTML = c.content || '';
                        app.fillCustomerInfo(c.clientName);
                    }
                } else {
                    docNumInput.value = 'CON-' + Date.now().toString().slice(-6);
                }
            },

            execCmd: (cmd, arg = null) => {
                document.execCommand(cmd, false, arg);
                document.getElementById('contract-editor').focus();
            },

            saveContract: async () => {
                const title = document.getElementById('contract-title').value;
                const docNum = document.getElementById('contract-doc-number').value;
                const clientName = document.getElementById('contract-client').value;
                const content = document.getElementById('contract-editor').innerHTML;
                
                const clientEmail = document.getElementById('client-email-hidden').value;
                const clientPhone = document.getElementById('client-phone-hidden').value;
                const clientAddress = document.getElementById('client-address-hidden').value;

                if(!title) return alert("Please enter a title");

                const data = {
                    title, clientName, content,
                    clientEmail, clientPhone, clientAddress,
                    quotationNumber: docNum, // User editable
                    securityCode: state.editingId ? undefined : `CON-${Math.random().toString(36).substring(2,8).toUpperCase()}`,
                    createdBy: state.user.uid
                };
                if(data.securityCode === undefined) delete data.securityCode;

                if (state.editingId) await updateDoc(doc(db, 'contracts', state.editingId), data);
                else {
                    await addDoc(collection(db, 'contracts'), {...data, createdAt: serverTimestamp()});
                }
                state.activeTab = 'contract';
                app.setView('dashboard');
            },

            // --- Payment Methods Logic ---
            initSettingsView: () => {
                app.fillSettingsForm();
                app.renderPaymentMethods();
            },

            renderPaymentMethods: () => {
                const list = document.getElementById('payment-methods-list');
                if(!list) return;
                const methods = state.payment_methods.length > 0 ? state.payment_methods : [];
                
                list.innerHTML = methods.map(m => `
                    <div class="flex justify-between items-center bg-white p-2 border rounded text-sm">
                        <span class="font-medium">${m.name}</span>
                        <div>
                            <button type="button" onclick="app.deletePaymentMethod('${m.id}')" class="text-red-600 hover:text-red-800 px-2">
                                <i data-lucide="trash-2" width="14"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
                if(methods.length === 0) list.innerHTML = `<div class="text-xs text-gray-400 italic">No custom methods. Using defaults (Cash, KPay, etc.)</div>`;
                lucide.createIcons();
            },

            addPaymentMethod: () => document.getElementById('payment-method-form').classList.remove('hidden'),

            savePaymentMethod: async () => {
                const name = document.getElementById('new-method-name').value.trim();
                if(!name) return;
                await addDoc(collection(db, 'payment_methods'), { name });
                document.getElementById('new-method-name').value = '';
                document.getElementById('payment-method-form').classList.add('hidden');
            },

            deletePaymentMethod: async (id) => {
                if(confirm("Delete this method?")) await deleteDoc(doc(db, 'payment_methods', id));
            },

            populatePaymentSelects: () => {
                const selects = document.querySelectorAll('.payment-method-select');
                const methods = state.payment_methods.length > 0 ? state.payment_methods : state.defaultMethods;
                
                selects.forEach(sel => {
                    const currentVal = sel.value; // Keep selection if re-rendering
                    sel.innerHTML = methods.map(m => `<option value="${m.name}">${m.name}</option>`).join('');
                    if(currentVal && methods.find(m => m.name === currentVal)) sel.value = currentVal;
                });
            },

            // --- Existing Functionality Updates ---

            showVerify: (id, type) => {
                const coll = type + 's';
                const d = state[coll].find(i => i.id === id);
                if(d) {
                    app.setView('verify');
                    app.renderPaper(d, type);
                }
            },

            switchTab: (tab) => {
                state.activeTab = tab;
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.className = `tab-btn whitespace-nowrap px-4 py-2 rounded-lg text-sm font-medium ${b.id === 'tab-'+tab ? 'bg-white border shadow-sm text-gray-800' : 'text-gray-500 hover:bg-gray-50'}`;
                });
                
                const actionBar = document.getElementById('action-bar');
                const filters = document.getElementById('report-filters');
                
                if(tab === 'report') {
                    if(actionBar) actionBar.style.display = 'none';
                    if(filters) {
                        filters.style.display = 'flex';
                        app.initReportFilters();
                    }
                    app.renderReports();
                } else {
                    if(actionBar) actionBar.style.display = 'flex';
                    if(filters) filters.style.display = 'none';
                    if(document.getElementById('create-btn-text')) document.getElementById('create-btn-text').innerText = `${app.t('create_new')}`;
                    app.renderList(state[tab + 's'], tab);
                }
            },

            renderList: (data, type) => {
                const container = document.getElementById('dashboard-content');
                if(!container) return;
                
                if(!data || data.length === 0) {
                    container.innerHTML = `<div class="p-8 text-center text-gray-400">No ${type}s found.</div>`;
                    return;
                }

                if (type === 'contract') {
                    container.innerHTML = `
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 border-b text-gray-600"><tr><th class="p-3">Title</th><th class="p-3">Client</th><th class="p-3">Date</th><th class="p-3 text-right">Actions</th></tr></thead>
                        <tbody class="divide-y">${data.map(c => `
                            <tr class="hover:bg-gray-50">
                                <td class="p-3 font-medium text-blue-600">${c.title}</td><td class="p-3">${c.clientName}</td><td class="p-3">${new Date(c.createdAt?.seconds*1000).toLocaleDateString()}</td>
                                <td class="p-3 text-right">
                                    <button onclick="app.showVerify('${c.id}', 'contract')" class="text-gray-600 p-1 mr-2"><i data-lucide="printer" width="16"></i></button>
                                    <button onclick="app.editContract('${c.id}')" class="text-blue-600 p-1 mr-2"><i data-lucide="pencil" width="16"></i></button>
                                    <button onclick="app.deleteDoc('${c.id}', 'contracts')" class="text-red-600 p-1"><i data-lucide="trash-2" width="16"></i></button>
                                </td>
                            </tr>`).join('')}</tbody>
                    </table>`;
                } else if (type === 'customer') {
                    container.innerHTML = `
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 border-b text-gray-600"><tr><th class="p-3">ID</th><th class="p-3">Name</th><th class="p-3">Phone</th><th class="p-3 text-right">Actions</th></tr></thead>
                        <tbody class="divide-y">${data.map(c => `
                            <tr class="hover:bg-gray-50">
                                <td class="p-3 font-mono text-gray-500">${c.customerId || '-'}</td>
                                <td class="p-3 font-medium">${c.name}</td><td class="p-3">${c.phone || '-'}</td>
                                <td class="p-3 text-right">
                                    <button onclick="app.editCustomer('${c.id}')" class="text-blue-600 p-1"><i data-lucide="pencil" width="16"></i></button>
                                    <button onclick="app.deleteDoc('${c.id}', 'customers')" class="text-red-600 p-1"><i data-lucide="trash-2" width="16"></i></button>
                                </td>
                            </tr>`).join('')}</tbody>
                    </table>`;
                } else if (type === 'expense') {
                    container.innerHTML = `
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 border-b text-gray-600"><tr><th class="p-3">Date</th><th class="p-3">Desc</th><th class="p-3">Method</th><th class="p-3 text-right">Amount</th><th class="p-3 text-right">Actions</th></tr></thead>
                        <tbody class="divide-y">${data.map(e => `
                            <tr class="hover:bg-gray-50">
                                <td class="p-3">${new Date(e.date).toLocaleDateString()}</td><td class="p-3 font-medium">${e.title}</td><td class="p-3"><span class="bg-gray-100 px-2 py-0.5 rounded text-xs">${e.method}</span></td>
                                <td class="p-3 text-right font-medium text-red-600">-${Number(e.amount).toLocaleString()}</td>
                                <td class="p-3 text-right">
                                    <button onclick="app.deleteDoc('${e.id}', 'expenses')" class="text-red-600 p-1"><i data-lucide="trash-2" width="16"></i></button>
                                </td>
                            </tr>`).join('')}</tbody>
                    </table>`;
                } else {
                    // Invoice & Quotation
                    container.innerHTML = `
                    <table class="w-full text-left text-sm">
                         <thead class="bg-gray-50 border-b text-gray-600"><tr><th class="p-3">ID</th><th class="p-3">Client</th><th class="p-3 text-right">Amount</th><th class="p-3 text-center">Status</th><th class="p-3 text-right">Actions</th></tr></thead>
                         <tbody class="divide-y">${data.map(item => {
                             const isPaid = item.status === 'paid';
                             const isPartial = item.status === 'partial';
                             let badge = type==='quotation' ? '<span class="px-2 py-0.5 rounded text-xs bg-gray-100">QTN</span>' : (isPaid ? '<span class="px-2 py-0.5 rounded text-xs bg-green-100 text-green-700">PAID</span>' : (isPartial ? '<span class="px-2 py-0.5 rounded text-xs bg-blue-100 text-blue-700">PARTIAL</span>' : '<span class="px-2 py-0.5 rounded text-xs bg-yellow-100 text-yellow-700">PENDING</span>'));
                             let paid = item.payments ? item.payments.reduce((s,p)=>s+p.amount,0) : 0;
                             let bal = item.totalAmount - paid;
                             
                             let actionBtns = `
                                <div class="flex items-center justify-end gap-1">
                                    <button onclick="app.showVerify('${item.id}', '${type}')" class="p-1.5 bg-gray-100 text-gray-600 rounded hover:bg-gray-200" title="Print/View"><i data-lucide="printer" width="14"></i></button>
                             `;
                             
                             if(type==='invoice') {
                                actionBtns += `<button onclick="app.handleStatusClick('${item.id}')" class="p-1.5 bg-blue-50 text-blue-600 rounded hover:bg-blue-100" title="Payment"><i data-lucide="credit-card" width="14"></i></button>`;
                             } else {
                                actionBtns += `<button onclick="app.convertQuotation('${item.id}')" class="p-1.5 bg-purple-50 text-purple-600 rounded hover:bg-purple-100" title="Convert"><i data-lucide="arrow-right-circle" width="14"></i></button>`;
                             }
                             
                             actionBtns += `
                                    <button onclick="app.editDoc('${item.id}', '${type}')" class="p-1.5 bg-yellow-50 text-yellow-600 rounded hover:bg-yellow-100" title="Edit"><i data-lucide="pencil" width="14"></i></button>
                                    <button onclick="app.deleteDoc('${item.id}', '${type}s')" class="p-1.5 bg-red-50 text-red-600 rounded hover:bg-red-100" title="Delete"><i data-lucide="trash-2" width="14"></i></button>
                                </div>
                             `;

                             return `<tr class="hover:bg-gray-50 border-b">
                                <td class="p-3 font-medium text-blue-600">${item.invoiceNumber || item.quotationNumber}</td>
                                <td class="p-3">${item.clientName}</td>
                                <td class="p-3 text-right"><div>${Number(item.totalAmount).toLocaleString()}</div>${type==='invoice' && bal>0 ? `<div class="text-xs text-red-500">Bal: ${bal.toLocaleString()}</div>` : ''}</td>
                                <td class="p-3 text-center">${badge}</td>
                                <td class="p-3 text-right">${actionBtns}</td>
                             </tr>`;
                          }).join('')}</tbody>
                    </table>`;
                }
                lucide.createIcons();
            },

            // --- Handlers ---
            handleCreateButtonClick: () => {
                const tab = state.activeTab;
                if(tab === 'invoice') app.showInvoiceOptionModal();
                else if(tab === 'quotation') app.createMode('quotation');
                else if(tab === 'contract') { state.editingId = null; app.setView('contract-edit'); }
                else if(tab === 'customer') app.openCustomerModal();
                else if(tab === 'expense') app.openExpenseModal();
            },

            // --- Forms/Modals Logic ---
            openCustomerModal: (cust = null) => {
                const modal = document.getElementById('modal-container');
                const tpl = document.getElementById('tpl-customer-form');
                modal.innerHTML = ''; modal.appendChild(tpl.content.cloneNode(true));
                app.translatePage();
                
                // Generate ID for new customer
                if(!cust) {
                    document.getElementById('cust-display-id').value = 'CUST-' + Date.now().toString().slice(-6);
                }

                if(cust) {
                    document.getElementById('cust-form-title').innerText = 'Edit Customer';
                    document.getElementById('cust-id').value = cust.id;
                    document.getElementById('cust-display-id').value = cust.customerId || 'CUST-' + Date.now().toString().slice(-6);
                    document.getElementById('cust-name').value = cust.name;
                    document.getElementById('cust-phone').value = cust.phone;
                    document.getElementById('cust-email').value = cust.email || '';
                    document.getElementById('cust-address').value = cust.address;
                }
            },
            saveCustomer: async (e) => {
                e.preventDefault();
                const id = document.getElementById('cust-id').value;
                const data = {
                    customerId: document.getElementById('cust-display-id').value,
                    name: document.getElementById('cust-name').value,
                    phone: document.getElementById('cust-phone').value,
                    email: document.getElementById('cust-email').value,
                    address: document.getElementById('cust-address').value
                };
                if(id) await updateDoc(doc(db, 'customers', id), data);
                else await addDoc(collection(db, 'customers'), {...data, createdAt: serverTimestamp()});
                app.closeModal();
            },
            editCustomer: (id) => app.openCustomerModal(state.customers.find(c => c.id === id)),
            fillCustomerInfo: (val) => {
                const cust = state.customers.find(c => c.name === val || c.id === val);
                const details = document.getElementById('client-details');
                
                if(cust) {
                    // Fill inputs
                    if(document.getElementById('client-name')) document.getElementById('client-name').value = cust.name;
                    if(document.getElementById('client-id')) document.getElementById('client-id').value = cust.id;
                    
                    // Fill ID input if exists (in create form)
                    if(document.getElementById('client-id-input')) document.getElementById('client-id-input').value = cust.customerId || '';
                    if(document.getElementById('contract-client-id')) document.getElementById('contract-client-id').value = cust.customerId || '';

                    // Display info
                    if(document.getElementById('client-phone')) document.getElementById('client-phone').innerText = cust.phone || '';
                    if(document.getElementById('client-address')) document.getElementById('client-address').innerText = cust.address || '';
                    
                    // Hidden fields for saving to doc
                    if(document.getElementById('client-email-hidden')) document.getElementById('client-email-hidden').value = cust.email || '';
                    if(document.getElementById('client-phone-hidden')) document.getElementById('client-phone-hidden').value = cust.phone || '';
                    if(document.getElementById('client-address-hidden')) document.getElementById('client-address-hidden').value = cust.address || '';

                    if(details) details.classList.remove('hidden');
                } else {
                    if(document.getElementById('client-id')) document.getElementById('client-id').value = '';
                    if(details) details.classList.add('hidden');
                }
            },
            
            fillCustomerById: (idVal) => {
                const cust = state.customers.find(c => c.customerId === idVal);
                if (cust) {
                    app.fillCustomerInfo(cust.name);
                }
            },

            openExpenseModal: () => {
                const modal = document.getElementById('modal-container');
                const tpl = document.getElementById('tpl-expense-form');
                modal.innerHTML = ''; modal.appendChild(tpl.content.cloneNode(true));
                app.translatePage();
                app.populatePaymentSelects(); // Populate methods
                document.getElementById('exp-date').valueAsDate = new Date();
            },
            saveExpense: async (e) => {
                e.preventDefault();
                const data = {
                    title: document.getElementById('exp-title').value,
                    amount: Number(document.getElementById('exp-amount').value),
                    method: document.getElementById('exp-method').value,
                    date: document.getElementById('exp-date').value,
                    createdAt: serverTimestamp()
                };
                await addDoc(collection(db, 'expenses'), data);
                app.closeModal();
            },

            initCreateForm: () => {
                const title = state.editingId ? `Edit ${state.mode}` : `New ${state.mode}`;
                document.getElementById('form-title').innerText = title;
                document.getElementById('form-mode-badge').innerText = state.mode;
                
                const dl = document.getElementById('customer-list');
                const dlIds = document.getElementById('customer-ids');
                dl.innerHTML = state.customers.map(c => `<option value="${c.name}">${c.phone || ''}</option>`).join('');
                dlIds.innerHTML = state.customers.map(c => `<option value="${c.customerId}">${c.name}</option>`).join('');

                const paySection = document.getElementById('invoice-payment-section');
                paySection.style.display = state.mode === 'quotation' ? 'none' : 'block';
                
                app.populatePaymentSelects(); // Populate methods
                app.renderCreateItems();
                
                // Set default doc number
                const docNumInput = document.getElementById('doc-number');
                if(!state.editingId) {
                    state.taxRate = state.settings.taxRate || 0;
                    document.getElementById('tax-input').value = state.taxRate;
                    docNumInput.value = (state.mode === 'invoice' ? 'INV-' : 'QTN-') + Date.now().toString().slice(-6);
                    app.calcTotal();
                }
            },

            handleSave: async (e) => {
                e.preventDefault();
                const clientName = document.getElementById('client-name').value;
                const clientId = document.getElementById('client-id').value; 
                const docNumber = document.getElementById('doc-number').value; // Get editable ID
                const clientEmail = document.getElementById('client-email-hidden').value;
                const clientPhone = document.getElementById('client-phone-hidden').value;
                const clientAddress = document.getElementById('client-address-hidden').value;

                const total = app.calcTotal();
                const col = state.mode + 's'; 
                try {
                    const docData = {
                        clientName, clientId, items: state.items, discount: state.discount, 
                        taxRate: state.taxRate, totalAmount: total,
                        clientEmail, clientPhone, clientAddress,
                        securityCode: state.editingId ? undefined : `SEC-${Math.random().toString(36).substring(2,8).toUpperCase()}`,
                        createdBy: state.user.uid
                    };
                    
                    // Assign editable number
                    docData[state.mode === 'invoice' ? 'invoiceNumber' : 'quotationNumber'] = docNumber;

                    if(docData.securityCode === undefined) delete docData.securityCode;

                    if (state.mode === 'invoice') {
                        if (!state.editingId && state.initPayment > 0) {
                            const m = document.getElementById('init-payment-method').value;
                            docData.payments = [{ amount: state.initPayment, method: m, date: new Date().toISOString() }];
                            docData.status = state.initPayment >= total ? 'paid' : 'partial';
                            if(docData.status === 'paid') docData.paidAt = serverTimestamp();
                        } else if (!state.editingId) { docData.payments = []; docData.status = 'pending'; }
                    }

                    if (state.editingId) await updateDoc(doc(db, col, state.editingId), docData);
                    else {
                        docData.createdAt = serverTimestamp();
                        await addDoc(collection(db, col), docData);
                    }
                    state.activeTab = state.mode; app.setView('dashboard');
                } catch(e) { alert(e.message); }
            },

            createMode: (mode) => { state.mode = mode; state.editingId = null; state.items = [{desc:'', price:0, qty:1}]; state.discount = 0; state.taxRate = state.settings.taxRate || 0; state.initPayment = 0; app.setView('create'); },
            createManualInvoice: () => { app.closeModal(); app.createMode('invoice'); },
            showInvoiceOptionModal: () => { document.getElementById('modal-container').appendChild(document.getElementById('tpl-invoice-option').content.cloneNode(true)); app.translatePage(); lucide.createIcons(); },
            closeModal: () => document.getElementById('modal-container').innerHTML = '',
            
            editDoc: (id, type) => {
                state.mode = type; state.editingId = id;
                const d = state[type + 's'].find(i => i.id === id);
                if(type === 'invoice' && d.status === 'paid' && prompt("Locked. Pass:") !== state.unlockPassword) return;
                state.items = JSON.parse(JSON.stringify(d.items)); state.discount = d.discount || 0; state.taxRate = d.taxRate || 0;
                app.setView('create');
                setTimeout(() => { 
                    document.getElementById('client-name').value = d.clientName; 
                    document.getElementById('discount-input').value = state.discount; 
                    document.getElementById('tax-input').value = state.taxRate;
                    document.getElementById('doc-number').value = d.invoiceNumber || d.quotationNumber;
                    
                    app.fillCustomerInfo(d.clientName); // Prefill hidden fields

                    if(type==='invoice'){ document.getElementById('init-payment-input').disabled = true; }
                    app.calcTotal();
                }, 100);
            },
            editContract: (id) => { state.editingId = id; app.setView('contract-edit'); },
            deleteDoc: async (id, coll) => {
                 if(coll === 'invoices' && state.invoices.find(i=>i.id===id).status === 'paid' && prompt("Pass:") !== state.unlockPassword) return;
                 if(confirm("Delete?")) await deleteDoc(doc(db, coll, id));
            },
            
            convertQuotation: (id) => {
                const q = state.quotations.find(i => i.id === id);
                if(!q || !confirm("Convert to Invoice?")) return;
                state.mode = 'invoice'; state.editingId = null; state.items = JSON.parse(JSON.stringify(q.items)); state.discount = q.discount || 0; state.taxRate = q.taxRate || 0; state.initPayment = 0;
                app.setView('create');
                setTimeout(() => { 
                    document.getElementById('client-name').value = q.clientName; 
                    document.getElementById('discount-input').value = state.discount; 
                    document.getElementById('tax-input').value = state.taxRate;
                    document.getElementById('doc-number').value = 'INV-' + Date.now().toString().slice(-6); // New Inv ID
                    app.fillCustomerInfo(q.clientName);
                    app.calcTotal();
                }, 100);
            },
            importQuotation: async () => {
                const val = document.getElementById('qtn-import-input').value.trim().toUpperCase();
                const snap = await getDocs(query(collection(db, 'quotations'), where("quotationNumber", "==", val)));
                if(snap.empty) return alert("Not Found");
                const q = snap.docs[0].data();
                app.closeModal(); state.mode = 'invoice'; state.editingId = null; state.items = q.items; state.discount = q.discount || 0; state.taxRate = q.taxRate || 0; state.initPayment = 0;
                app.setView('create'); 
                setTimeout(() => { 
                    document.getElementById('client-name').value = q.clientName; 
                    document.getElementById('discount-input').value = state.discount; 
                    document.getElementById('tax-input').value = state.taxRate;
                    document.getElementById('doc-number').value = 'INV-' + Date.now().toString().slice(-6);
                    app.fillCustomerInfo(q.clientName);
                    app.calcTotal();
                }, 100);
            },

            // Items Logic
            renderCreateItems: () => {
                const c = document.getElementById('items-container'); c.innerHTML = `<label class="block text-sm font-medium mb-2">${app.t('items')}</label>`;
                state.items.forEach((item, i) => {
                    const div = document.createElement('div'); div.className = "flex gap-2 mb-2 items-start";
                    div.innerHTML = `<span class="pt-2 text-sm font-bold text-gray-500 w-6">${i+1}.</span><input placeholder="${app.t('desc')}" class="flex-grow border p-2 rounded w-1/3" onchange="app.updateItem(${i}, 'desc', this.value)" value="${item.desc}"><input type="number" placeholder="${app.t('qty')}" class="w-16 border p-2 rounded" onchange="app.updateItem(${i}, 'qty', this.value)" value="${item.qty}"><input type="number" placeholder="${app.t('price')}" class="w-24 border p-2 rounded" onchange="app.updateItem(${i}, 'price', this.value)" value="${item.price}"><button type="button" onclick="app.triggerImageUpload(${i})" class="p-2 border rounded"><i data-lucide="camera" width="16"></i></button><button type="button" onclick="app.removeItem(${i})" class="text-red-500 p-2"><i data-lucide="x-circle" width="16"></i></button>`;
                    c.appendChild(div);
                });
                lucide.createIcons(); app.calcTotal();
            },
            updateItem: (i, f, v) => { state.items[i][f] = f==='desc'?v:Number(v); app.calcTotal(); },
            addItem: () => { state.items.push({desc:'',price:0,qty:1}); app.renderCreateItems(); },
            removeItem: (i) => { state.items.splice(i,1); app.renderCreateItems(); },
            updateCalc: (v, t) => { 
                if(t==='discount') state.discount=Number(v); 
                if(t==='tax') state.taxRate=Number(v);
                if(t==='payment') state.initPayment=Number(v); 
                app.calcTotal(); 
            },
            calcTotal: () => {
                const sub = state.items.reduce((s,i)=>s+(i.price*i.qty),0); 
                const taxAmt = sub * (state.taxRate / 100);
                const tot = sub - state.discount + taxAmt;
                
                document.getElementById('subtotal-display').innerText = sub.toLocaleString();
                document.getElementById('create-total').innerText = tot.toLocaleString();
                if(document.getElementById('create-balance')) document.getElementById('create-balance').innerText = (tot - state.initPayment).toLocaleString();
                return tot;
            },
            triggerImageUpload: (i) => { state.uploadingRowIndex = i; document.getElementById('item-image-input').click(); },
            processItemImage: (input) => { app.processImageBase(input, (url) => { state.items[state.uploadingRowIndex].image = url; alert("Image Added"); }); },

            // Auth & Settings
            handleAuthClick: () => state.isAdmin ? app.setView('dashboard') : app.setView('login'),
            handleEmailAuth: async (e) => { e.preventDefault(); try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); app.setView('dashboard'); } catch(e){ document.getElementById('auth-error').innerText=e.message; document.getElementById('auth-error').classList.remove('hidden'); } },
            googleLogin: async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); app.setView('dashboard'); } catch(e){alert(e.message);} },
            logout: async () => { await signOut(auth); state.isAdmin = false; app.setView('home'); try{await signInAnonymously(auth);}catch(e){} },
            
            fillSettingsForm: () => {
                if(state.settings.logo) document.getElementById('logo-preview').innerHTML = `<img src="${state.settings.logo}" class="h-full object-contain">`;
                if(state.settings.authSign) document.getElementById('sign-preview').innerHTML = `<img src="${state.settings.authSign}" class="h-full object-contain">`;
                document.getElementById('setting-accounts').value = state.settings.accounts || '';
                document.getElementById('setting-terms').value = state.settings.terms || '';
                document.getElementById('setting-auth-name').value = state.settings.authName || '';
                
                // New Fields
                document.getElementById('setting-biz-address').value = state.settings.bizAddress || '';
                document.getElementById('setting-biz-phone').value = state.settings.bizPhone || '';
                document.getElementById('setting-biz-web').value = state.settings.bizWeb || '';
                document.getElementById('setting-biz-email').value = state.settings.bizEmail || '';
                document.getElementById('setting-tax').value = state.settings.taxRate || 0;
            },
            handleSaveSettings: async (e) => {
                e.preventDefault();
                state.settings.accounts = document.getElementById('setting-accounts').value;
                state.settings.terms = document.getElementById('setting-terms').value;
                state.settings.authName = document.getElementById('setting-auth-name').value;
                
                // Save New Fields
                state.settings.bizAddress = document.getElementById('setting-biz-address').value;
                state.settings.bizPhone = document.getElementById('setting-biz-phone').value;
                state.settings.bizWeb = document.getElementById('setting-biz-web').value;
                state.settings.bizEmail = document.getElementById('setting-biz-email').value;
                state.settings.taxRate = Number(document.getElementById('setting-tax').value);

                await setDoc(doc(db, 'invoices', 'config_general'), state.settings);
                alert("Saved"); app.setView('dashboard');
            },
            processImageBase: (input, cb) => {
                if(!input.files[0]) return;
                const r = new FileReader(); r.onload = (e) => { const i = new Image(); i.onload = () => { const c = document.createElement('canvas'); const s = 300/i.width; c.width=300; c.height=i.height*s; c.getContext('2d').drawImage(i,0,0,c.width,c.height); cb(c.toDataURL('image/png')); input.value=''; }; i.src=e.target.result; }; r.readAsDataURL(input.files[0]);
            },
            processLogo: (i) => app.processImageBase(i, (u) => { state.settings.logo = u; document.getElementById('logo-preview').innerHTML = `<img src="${u}" class="h-full">`; }),
            processSign: (i) => app.processImageBase(i, (u) => { state.settings.authSign = u; document.getElementById('sign-preview').innerHTML = `<img src="${u}" class="h-full">`; }),

            // Search/Print/Verify
            handleSearch: async (v) => {
                const q = (v || document.getElementById('search-input').value).trim();
                if(!q) return;
                app.setView('verify');
                const search = async (c, f) => { const s = await getDocs(query(collection(db,c), where(f,"==",q))); return !s.empty ? {id:s.docs[0].id, ...s.docs[0].data(), type:c.slice(0,-1)} : null; };
                let f = await search('invoices','invoiceNumber') || await search('quotations','quotationNumber') || await search('contracts','quotationNumber') || await search('invoices','securityCode') || await search('quotations','securityCode') || await search('contracts','securityCode');
                if(f) app.renderPaper(f, f.type);
                else document.getElementById('verify-content').innerHTML = '<div class="p-10 text-center text-red-500 font-bold">Not Found</div>';
            },
            renderPaper: (d, t) => {
                state.currentDoc = d;
                // QR Logic Update: Full URL
                const codeToEncode = d.securityCode || d.invoiceNumber || d.quotationNumber || 'N/A';
                const fullUrl = window.location.origin + window.location.pathname + '?code=' + codeToEncode;
                const qr = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(fullUrl)}`;
                
                const logo = state.settings.logo ? `<img src="${state.settings.logo}" class="h-20">` : '';
                const sign = state.settings.authSign ? `<img src="${state.settings.authSign}" class="h-16 mx-auto">` : '';
                
                // Business Info Block
                const bizInfo = `
                    <div class="text-xs text-gray-500 mt-2">
                        ${state.settings.bizAddress ? `<div>${state.settings.bizAddress}</div>` : ''}
                        ${state.settings.bizPhone ? `<div>${state.settings.bizPhone}</div>` : ''}
                        ${state.settings.bizEmail ? `<div>${state.settings.bizEmail}</div>` : ''}
                        ${state.settings.bizWeb ? `<div>${state.settings.bizWeb}</div>` : ''}
                    </div>
                `;

                if (t === 'contract') {
                    document.getElementById('verify-content').innerHTML = `
                    <div id="contract-paper" class="a4-paper">
                         <div class="flex justify-between items-start mb-8 border-b pb-4">
                            <div>${logo}${bizInfo}</div>
                            <div class="text-right">
                                <h1 class="text-2xl font-bold uppercase text-gray-800">${d.title}</h1>
                                <p class="text-sm text-gray-500">Date: ${new Date(d.createdAt?.seconds*1000).toLocaleDateString()}</p>
                                <div class="mt-2 text-sm">
                                    <p class="font-bold">Contract With:</p>
                                    <p>${d.clientName}</p>
                                    ${d.clientPhone ? `<p>${d.clientPhone}</p>`:''}
                                    ${d.clientEmail ? `<p>${d.clientEmail}</p>`:''}
                                </div>
                            </div>
                         </div>
                         <div class="prose max-w-none mb-12">
                             ${d.content}
                         </div>
                         <div class="absolute bottom-12 left-12 right-12 flex justify-between items-end">
                             <div>
                                <p class="font-bold border-t pt-2 w-48">Client Signature</p>
                             </div>
                             <div class="text-center">
                                ${sign}
                                <p class="font-bold border-t pt-2 w-48 mx-auto">${state.settings.authName || 'Authorized Signature'}</p>
                             </div>
                             <div>
                                <img src="${qr}" class="w-16">
                             </div>
                         </div>
                    </div>`;
                    lucide.createIcons();
                    app.scalePaper(); // Trigger scale
                    return;
                }

                // Invoice/Quotation Render
                document.getElementById('verify-content').innerHTML = `
                <div id="invoice-paper" class="a4-paper flex flex-col justify-between">
                    <div>
                        <div class="flex justify-between border-b pb-6 mb-6">
                            <div>
                                <h1 class="text-3xl font-bold text-blue-900 uppercase">${t}</h1>
                                <p class="font-bold text-lg">#${d.invoiceNumber||d.quotationNumber}</p>
                                ${bizInfo}
                            </div>
                            <div class="text-right">${logo}</div>
                        </div>
                        <div class="flex justify-between mb-8">
                            <div>
                                <h3 class="font-bold text-gray-600 uppercase text-xs mb-1">${app.t('bill_to')}</h3>
                                <p class="font-bold text-lg">${d.clientName}</p>
                                <div class="text-sm text-gray-500">
                                    ${d.clientAddress ? `<div>${d.clientAddress}</div>` : ''}
                                    ${d.clientPhone ? `<div>${d.clientPhone}</div>` : ''}
                                    ${d.clientEmail ? `<div>${d.clientEmail}</div>` : ''}
                                </div>
                            </div>
                            <div class="text-right">
                                <h3 class="font-bold">${app.t('date')}</h3><p>${new Date(d.createdAt?.seconds*1000||Date.now()).toLocaleDateString()}</p>${t==='invoice'&&d.status==='paid'?'<div class="text-green-700 font-bold border-2 border-green-700 inline-block px-2 mt-2">PAID</div>':''}
                                ${t==='invoice'&&d.payments?.length?`<div class="mt-4 text-xs text-gray-500 text-right"><p class="font-bold mb-1 underline">${app.t('payment_history')}</p><table class="w-full text-right ml-auto" style="width: auto;">${d.payments.map(p=>`<tr><td class="pr-2">${new Date(p.date).toLocaleDateString()}</td><td class="pr-2">(${p.method})</td><td class="font-bold">${p.amount.toLocaleString()}</td></tr>`).join('')}</table></div>`:''}
                            </div>
                        </div>
                        <table class="w-full mb-6 text-sm"><thead class="bg-gray-100"><tr><th class="p-2 text-left">${app.t('no')}</th><th class="p-2 text-left">${app.t('desc')}</th><th class="p-2 text-right">${app.t('qty')}</th><th class="p-2 text-right">${app.t('price')}</th><th class="p-2 text-right">${app.t('total')}</th></tr></thead><tbody>${d.items.map((i, index)=>`<tr><td class="p-2 border-b text-gray-500">${index + 1}</td><td class="p-2 border-b"><div>${i.desc}</div>${i.image ? `<img src="${i.image}" class="mt-2 h-16 w-auto object-cover border rounded">` : ''}</td><td class="p-2 border-b text-right">${i.qty}</td><td class="p-2 border-b text-right">${i.price.toLocaleString()}</td><td class="p-2 border-b text-right">${(i.price*i.qty).toLocaleString()}</td></tr>`).join('')}</tbody></table>
                    </div>
                    <div>
                        <div class="flex justify-between items-start border-t pt-4">
                            <div class="w-1/2 text-sm">
                                <p class="font-bold">${app.t('payment_info')}</p><pre class="font-sans text-xs whitespace-pre-line">${state.settings.accounts||''}</pre>
                                <div class="mt-4"><p class="font-bold">${app.t('terms_conditions')}</p><p class="whitespace-pre-line text-xs text-gray-600">${state.settings.terms||'-'}</p></div>
                                <div class="mt-4"><img src="${qr}" class="w-20 border p-1"></div>
                            </div>
                            <div class="w-1/3 text-right">
                                <div class="flex justify-between"><span>${app.t('subtotal')}</span><span>${d.items.reduce((s,i)=>s+i.price*i.qty,0).toLocaleString()}</span></div>
                                ${d.discount?`<div class="flex justify-between text-red-500"><span>${app.t('discount')}</span><span>-${d.discount.toLocaleString()}</span></div>`:''}
                                ${d.taxRate?`<div class="flex justify-between text-gray-600"><span>Tax (${d.taxRate}%)</span><span>+${(d.items.reduce((s,i)=>s+i.price*i.qty,0) * (d.taxRate/100)).toLocaleString()}</span></div>`:''}
                                <div class="flex justify-between font-bold text-lg mt-2 border-t pt-2"><span>${app.t('total')}</span><span>${d.totalAmount.toLocaleString()}</span></div>
                                
                                <div class="mt-10 text-center w-48 ml-auto">
                                    ${sign}
                                    <p class="text-xs font-bold uppercase mt-1">${state.settings.authName||''}</p>
                                    <div class="border-b border-gray-800 mt-1 mb-1"></div>
                                    <p class="text-[10px] text-gray-500">${app.t('authorized_signature')}</p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-8 text-center text-[10px] text-gray-400 border-t pt-2">
                            ${app.t('system_generated')}
                        </div>
                    </div>
                </div>`;
                lucide.createIcons();
                app.scalePaper(); // Trigger scale
            },
            
            // --- UPDATED DOWNLOAD FUNCTION ---
            downloadPDF: async () => {
                const element = document.getElementById('invoice-paper') || document.getElementById('contract-paper');
                // Temporarily remove scale for clear PDF generation
                const oldTransform = element.style.transform;
                element.style.transform = 'none';
                
                const canvas = await html2canvas(element, { scale: 2, useCORS: true });
                
                // Restore scale
                element.style.transform = oldTransform;

                const imgData = canvas.toDataURL('image/png');

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const margin = 0; // A4 div has padding already
                const pdfWidth = 210;
                const contentWidth = pdfWidth; 
                const contentHeight = (canvas.height * contentWidth) / canvas.width;

                pdf.addImage(imgData, 'PNG', 0, 0, contentWidth, contentHeight);
                const name = state.currentDoc ? (state.currentDoc.invoiceNumber || state.currentDoc.quotationNumber || 'Document') : 'Document';
                pdf.save(`${name}.pdf`);
            },
            backHome: () => app.setView(state.isAdmin ? 'dashboard' : 'home'),
            
            // Scanner / Payment Status
            startScanner: () => {
                document.getElementById('scanner-modal').classList.remove('hidden');
                state.html5QrCode = new Html5Qrcode("reader");
                state.html5QrCode.start({facingMode:"environment"}, {fps:10, qrbox:250}, (t)=>{ app.stopScanner(); if(t.includes('code=')) app.handleSearch(new URL(t).searchParams.get('code')); else app.handleSearch(t); }).catch(()=>{});
            },
            stopScanner: () => { if(state.html5QrCode) state.html5QrCode.stop().then(()=>document.getElementById('scanner-modal').classList.add('hidden')); else document.getElementById('scanner-modal').classList.add('hidden'); },
            handleStatusClick: (id) => {
                const i = state.invoices.find(x=>x.id===id);
                if(i.status==='paid'){ if(prompt("Pass:")!==state.unlockPassword) return; return updateDoc(doc(db,'invoices',id),{status:'pending',payments:[]}); }
                const paid = i.payments?i.payments.reduce((s,p)=>s+p.amount,0):0;
                state.tempInvoice = {...i, paid, balance: i.totalAmount-paid};
                const m = document.getElementById('tpl-payment-modal').content.cloneNode(true);
                document.getElementById('modal-container').innerHTML = ''; document.getElementById('modal-container').appendChild(m);
                app.translatePage(); // Translate modal
                app.populatePaymentSelects(); // Populate methods
                document.getElementById('modal-total').innerText = i.totalAmount.toLocaleString();
                document.getElementById('modal-paid').innerText = paid.toLocaleString();
                document.getElementById('modal-balance').innerText = state.tempInvoice.balance.toLocaleString();
                document.getElementById('payment-amount').value = state.tempInvoice.balance;
            },
            confirmPayment: async () => {
                const amt = Number(document.getElementById('payment-amount').value);
                const met = document.getElementById('payment-method-select').value;
                const inv = state.tempInvoice;
                const pays = [...(inv.payments||[]), {amount:amt, method:met, date:new Date().toISOString()}];
                const stat = pays.reduce((s,p)=>s+p.amount,0) >= inv.totalAmount ? 'paid' : 'partial';
                await updateDoc(doc(db,'invoices',inv.id), {status:stat, payments:pays, paidAt: stat==='paid'?serverTimestamp():null});
                app.closeModal();
            },

            // --- Reports Logic ---
            initReportFilters: () => {
                const yearSelect = document.getElementById('report-year');
                const custSelect = document.getElementById('report-customer');
                if(yearSelect.options.length > 0) return; // already init
                const currentYear = new Date().getFullYear();
                yearSelect.innerHTML = `<option value="all">All Years</option>`;
                for(let i=currentYear-2; i<=currentYear+1; i++) {
                    yearSelect.innerHTML += `<option value="${i}" ${i===currentYear?'selected':''}>${i}</option>`;
                }
                custSelect.innerHTML = `<option value="all">All Customers</option>` + state.customers.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            },
            renderReports: () => {
                const container = document.getElementById('dashboard-content');
                const fYear = document.getElementById('report-year')?.value || 'all';
                const fMonth = document.getElementById('report-month')?.value || 'all';
                const fCust = document.getElementById('report-customer')?.value || 'all';

                const checkDate = (timestamp) => {
                    const d = timestamp?.seconds ? new Date(timestamp.seconds*1000) : new Date(timestamp);
                    if(fYear !== 'all' && d.getFullYear() != fYear) return false;
                    if(fMonth !== 'all' && d.getMonth() != fMonth) return false;
                    return true;
                };

                const filteredInvoices = state.invoices.filter(i => checkDate(i.createdAt) && (fCust === 'all' || i.clientName === fCust));
                const filteredExpenses = state.expenses.filter(e => checkDate(e.date)); 
                const filteredQuotations = state.quotations.filter(q => checkDate(q.createdAt) && (fCust === 'all' || q.clientName === fCust));

                let totalIncome = 0;
                let totalReceivable = 0;
                let totalExpense = 0;
                const methods = {};
                const expMethods = {};

                filteredInvoices.forEach(inv => {
                    let paid = 0;
                    if(inv.payments) {
                        inv.payments.forEach(p => {
                            paid += p.amount;
                            totalIncome += p.amount; 
                            let m = p.method;
                            if(!methods[m]) methods[m] = 0;
                            methods[m] += p.amount;
                        });
                    }
                    if(paid < inv.totalAmount) totalReceivable += (inv.totalAmount - paid);
                });

                filteredExpenses.forEach(e => {
                    totalExpense += Number(e.amount);
                    let m = e.method;
                    if(!expMethods[m]) expMethods[m] = 0;
                    expMethods[m] += Number(e.amount);
                });

                const netProfit = totalIncome - totalExpense;

                container.innerHTML = `
                <div class="p-4 bg-gray-50 min-h-screen">
                    <h3 class="font-bold text-lg mb-4 text-gray-700">${app.t('financial_overview')} (${fYear==='all'?'All':fYear}${fMonth!=='all'?'/'+(parseInt(fMonth)+1):''})</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-white p-4 rounded-lg shadow border-l-4 border-green-500">
                            <div class="text-xs text-gray-500 uppercase">${app.t('income')}</div>
                            <div class="text-xl font-bold text-green-600">${totalIncome.toLocaleString()}</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow border-l-4 border-red-500">
                            <div class="text-xs text-gray-500 uppercase">${app.t('expense_label')}</div>
                            <div class="text-xl font-bold text-red-600">${totalExpense.toLocaleString()}</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow border-l-4 border-blue-500">
                            <div class="text-xs text-gray-500 uppercase">${app.t('net_profit')}</div>
                            <div class="text-xl font-bold text-blue-600">${netProfit.toLocaleString()}</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow border-l-4 border-yellow-500">
                            <div class="text-xs text-gray-500 uppercase">${app.t('receivable')}</div>
                            <div class="text-xl font-bold text-yellow-600">${totalReceivable.toLocaleString()}</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div>
                            <h3 class="font-bold text-sm mb-2 text-gray-600">${app.t('method_breakdown')} (In - Out)</h3>
                            <div class="space-y-2">
                                ${Object.keys({...methods, ...expMethods}).map(m => {
                                    const inc = methods[m] || 0;
                                    const out = expMethods[m] || 0;
                                    const bal = inc - out;
                                    return `
                                    <div class="bg-white p-3 rounded shadow-sm border flex justify-between items-center">
                                        <div class="font-medium text-gray-700">${m}</div>
                                        <div class="text-right">
                                            <div class="font-bold ${bal>=0?'text-green-600':'text-red-600'}">${bal.toLocaleString()}</div>
                                            <div class="text-[10px] text-gray-400">In: ${inc.toLocaleString()} | Out: ${out.toLocaleString()}</div>
                                        </div>
                                    </div>`;
                                }).join('')}
                            </div>
                        </div>
                        <div>
                            <h3 class="font-bold text-sm mb-2 text-gray-600">${app.t('quotation_stats')}</h3>
                            <div class="bg-white p-4 rounded shadow-sm border h-full">
                                <div class="flex justify-between border-b pb-2 mb-2">
                                    <span>${app.t('total_created')}</span>
                                    <span class="font-bold">${filteredQuotations.length}</span>
                                </div>
                                <div class="flex justify-between border-b pb-2 mb-2">
                                    <span>Contracts Created</span>
                                    <span class="font-bold text-blue-600">${state.contracts.length}</span> 
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            }
        };
        window.app = app; app.init();
    </script>
</body>
</html>
