<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Myanmar Invoice System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Padauk:wght@400;700&display=swap');
        body { font-family: 'Padauk', sans-serif; }
        
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        @media print {
            body * { visibility: hidden; }
            #invoice-paper, #invoice-paper * { visibility: visible; }
            #invoice-paper { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; box-shadow: none; border: none; }
            @page { size: auto; margin: 5mm; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm border-b px-4 py-3 flex justify-between items-center no-print">
        <div class="flex items-center gap-2 cursor-pointer" onclick="app.setView('home')">
            <div class="bg-blue-600 text-white p-2 rounded-lg">
                <i data-lucide="file-text"></i>
            </div>
            <h1 class="font-bold text-lg text-blue-900">Myanmar Invoice</h1>
        </div>
        <div id="auth-buttons">
            <!-- Will be populated by JS -->
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-5xl mx-auto p-4" id="main-container">
        <!-- Views will be injected here -->
    </main>

    <!-- TEMPLATES (Hidden by default) -->
    
    <!-- 1. Home View Template -->
    <template id="tpl-home">
        <div class="flex flex-col items-center justify-center py-20 text-center space-y-8 fade-in">
            <div class="bg-white p-4 rounded-full shadow-sm mb-2">
                <i data-lucide="shield-check" class="text-blue-600 w-12 h-12"></i>
            </div>
            <h2 class="text-3xl md:text-5xl font-extrabold text-gray-900">ငွေပေးချေမှု စစ်ဆေးရန်စနစ်</h2>
            <p class="text-gray-500 max-w-md">Invoice နံပါတ် သို့မဟုတ် Security Code ရိုက်ထည့်၍သော်လည်းကောင်း၊ QR Code Scan ဖတ်၍သော်လည်းကောင်း စစ်ဆေးနိုင်ပါသည်။</p>
            
            <div class="w-full max-w-md bg-white p-2 rounded-full shadow-lg border flex">
                <input type="text" id="search-input" placeholder="Invoice No (သို့) Security Code" class="flex-1 px-6 py-3 rounded-l-full outline-none text-gray-700">
                <button onclick="app.handleSearch()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-full font-medium transition-colors">စစ်မည်</button>
            </div>
        </div>
    </template>

    <!-- 2. Admin Login Template -->
    <template id="tpl-login">
        <div class="max-w-md mx-auto mt-10 bg-white p-8 rounded-2xl shadow-xl border fade-in">
            <h2 class="text-2xl font-bold mb-2 text-center text-gray-800" id="login-title">Admin ဝင်ရောက်ရန်</h2>
            <p class="text-center text-gray-500 text-sm mb-6" id="login-subtitle">သင့်အီးမေးလ်နှင့် စကားဝှက်ကို အသုံးပြုပါ</p>
            
            <button onclick="app.googleLogin()" class="w-full mb-6 flex items-center justify-center gap-2 bg-white border border-gray-300 text-gray-700 py-2.5 rounded-lg hover:bg-gray-50 font-medium shadow-sm">
                Sign in with Google
            </button>

            <div class="relative flex py-2 items-center mb-6">
                <div class="flex-grow border-t border-gray-300"></div>
                <span class="flex-shrink-0 mx-4 text-gray-400 text-sm">Or with Email</span>
                <div class="flex-grow border-t border-gray-300"></div>
            </div>

            <form onsubmit="app.handleEmailAuth(event)" class="space-y-4">
                <div id="auth-error" class="hidden bg-red-50 text-red-600 text-sm p-3 rounded-lg border border-red-200"></div>
                <input type="email" id="email" class="w-full border px-4 py-2 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="admin@example.com" required>
                <input type="password" id="password" class="w-full border px-4 py-2 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="••••••" required>
                <button type="submit" id="auth-submit-btn" class="w-full bg-blue-600 text-white py-2.5 rounded-lg hover:bg-blue-700 transition font-medium">ဝင်ရောက်မည် (Login)</button>
            </form>

            <div class="mt-6 text-center text-sm">
                <p id="toggle-auth-text">အကောင့်မရှိသေးဘူးလား? <button onclick="app.toggleAuthMode()" class="text-blue-600 font-bold hover:underline">အသစ်ဖွင့်ပါ</button></p>
            </div>
        </div>
    </template>

    <!-- 3. Dashboard Template -->
    <template id="tpl-dashboard">
        <div class="fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Invoices စာရင်း</h2>
                <button onclick="app.setView('create')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-sm">
                    <i data-lucide="plus"></i> အသစ်ဖန်တီးမည်
                </button>
            </div>
            <div class="bg-white rounded-xl shadow overflow-hidden border">
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="p-4 font-semibold text-gray-600">Invoice / Security</th>
                                <th class="p-4 font-semibold text-gray-600">Client</th>
                                <th class="p-4 font-semibold text-gray-600">Amount</th>
                                <th class="p-4 font-semibold text-gray-600">Date</th>
                                <th class="p-4 font-semibold text-gray-600">Status</th>
                                <th class="p-4 font-semibold text-gray-600">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="invoice-list" class="divide-y">
                            <!-- JS will populate rows -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </template>

    <!-- 4. Create Invoice Template -->
    <template id="tpl-create">
        <div class="max-w-3xl mx-auto bg-white p-6 rounded-xl shadow-lg border fade-in">
            <h2 class="text-xl font-bold mb-6 border-b pb-2">Invoice အသစ်ဖန်တီးခြင်း</h2>
            <form onsubmit="app.handleCreate(event)" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Client Name</label>
                    <input type="text" id="client-name" required class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                
                <div id="items-container">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Items</label>
                    <!-- Items will be added here -->
                </div>
                
                <button type="button" onclick="app.addItem()" class="text-sm text-blue-600 font-medium flex items-center gap-1">
                    <i data-lucide="plus"></i> နောက်ထပ်ထည့်မည်
                </button>

                <div class="border-t pt-4 flex justify-between items-center">
                    <div class="text-xl font-bold text-gray-800">Total: <span id="create-total">0</span> Ks</div>
                    <div class="flex gap-3">
                        <button type="button" onclick="app.setView('dashboard')" class="px-4 py-2 text-gray-600 bg-gray-100 rounded">Cancel</button>
                        <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded">Create</button>
                    </div>
                </div>
            </form>
        </div>
    </template>

    <!-- 5. Verify/Print Template -->
    <template id="tpl-verify">
        <div class="flex flex-col items-center fade-in">
            <div class="w-full max-w-4xl mb-4 flex justify-between no-print">
                <button onclick="app.backHome()" class="flex items-center gap-2 text-gray-600 hover:text-gray-900">
                    <i data-lucide="arrow-left"></i> Back
                </button>
                <div class="flex gap-2" id="verify-actions">
                    <button onclick="window.print()" class="bg-white border text-blue-600 px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-blue-50">
                        <i data-lucide="printer"></i> Print / PDF
                    </button>
                    <button onclick="app.downloadPDF()" class="bg-gray-800 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-gray-900">
                        <i data-lucide="download"></i> Download Image PDF
                    </button>
                </div>
            </div>

            <div id="verify-content" class="w-full flex justify-center">
                <!-- Invoice Paper or Not Found Message -->
            </div>
        </div>
    </template>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, doc, onSnapshot, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBz5Cm-qsKe9pshGLaBkzw0WTOg9OLDwHk",
            authDomain: "invoice-99bdb.firebaseapp.com",
            projectId: "invoice-99bdb",
            storageBucket: "invoice-99bdb.firebasestorage.app",
            messagingSenderId: "1055209115726",
            appId: "1:1055209115726:web:926791697e6ad783e5b31f"
        };

        const appInstance = initializeApp(firebaseConfig);
        const auth = getAuth(appInstance);
        const db = getFirestore(appInstance);

        // --- App Logic ---
        const state = {
            user: null,
            isAdmin: false,
            view: 'home',
            invoices: [],
            currentInvoice: null,
            isRegistering: false,
            items: [{desc: '', price: 0, qty: 1}]
        };

        const app = {
            init: () => {
                // Auth Listener
                onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        state.user = u;
                        state.isAdmin = !u.isAnonymous;
                        if(state.isAdmin) app.listenInvoices();
                    } else {
                        // Public Anonymous Login
                        try { await signInAnonymously(auth); } catch(e) { console.error(e); }
                    }
                    app.renderNavbar();
                    
                    // Check URL params
                    const params = new URLSearchParams(window.location.search);
                    if(params.get('id') || params.get('code')) {
                        app.handleSearch(params.get('code') || params.get('id'));
                    }
                });
                lucide.createIcons();
            },

            setView: (viewName) => {
                state.view = viewName;
                const main = document.getElementById('main-container');
                const tpl = document.getElementById(`tpl-${viewName}`);
                
                if(viewName === 'dashboard' && !state.isAdmin) return app.setView('login');
                
                main.innerHTML = '';
                main.appendChild(tpl.content.cloneNode(true));
                lucide.createIcons();

                if(viewName === 'dashboard') app.renderInvoiceList();
                if(viewName === 'create') {
                    state.items = [{desc: '', price: 0, qty: 1}];
                    app.renderCreateItems();
                }
            },

            renderNavbar: () => {
                const container = document.getElementById('auth-buttons');
                if(state.isAdmin) {
                    container.innerHTML = `<button onclick="app.logout()" class="text-sm text-red-500 font-medium hover:underline flex items-center gap-1"><i data-lucide="log-out" width="16"></i> Logout</button>`;
                } else {
                    container.innerHTML = `<button onclick="app.setView('login')" class="text-sm text-blue-600 font-medium hover:underline flex items-center gap-1"><i data-lucide="log-in" width="16"></i> Admin Login</button>`;
                }
                lucide.createIcons();
            },

            // --- Auth ---
            toggleAuthMode: () => {
                state.isRegistering = !state.isRegistering;
                document.getElementById('login-title').innerText = state.isRegistering ? 'Admin အကောင့်သစ်ဖွင့်ရန်' : 'Admin ဝင်ရောက်ရန်';
                document.getElementById('auth-submit-btn').innerText = state.isRegistering ? 'Sign Up' : 'Login';
                document.getElementById('toggle-auth-text').innerHTML = state.isRegistering ? 
                    `အကောင့်ရှိပြီးသားလား? <button onclick="app.toggleAuthMode()" class="text-blue-600 font-bold hover:underline">Login ဝင်ပါ</button>` : 
                    `အကောင့်မရှိသေးဘူးလား? <button onclick="app.toggleAuthMode()" class="text-blue-600 font-bold hover:underline">အသစ်ဖွင့်ပါ</button>`;
            },

            handleEmailAuth: async (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const pass = document.getElementById('password').value;
                const errDiv = document.getElementById('auth-error');
                errDiv.classList.add('hidden');

                try {
                    if(state.isRegistering) await createUserWithEmailAndPassword(auth, email, pass);
                    else await signInWithEmailAndPassword(auth, email, pass);
                    app.setView('dashboard');
                } catch (err) {
                    errDiv.innerText = err.message;
                    errDiv.classList.remove('hidden');
                }
            },

            googleLogin: async () => {
                try {
                    const provider = new GoogleAuthProvider();
                    provider.setCustomParameters({ client_id: '1055209115726-8ng62eogmv65v2smavt6ohqvohf5krcc.apps.googleusercontent.com' });
                    await signInWithPopup(auth, provider);
                    app.setView('dashboard');
                } catch (e) { alert("Google Sign in error"); }
            },

            logout: async () => {
                await signOut(auth);
                state.isAdmin = false;
                app.setView('home');
                try { await signInAnonymously(auth); } catch(e){}
            },

            // --- Invoice Logic ---
            listenInvoices: () => {
                const q = collection(db, 'invoices');
                onSnapshot(q, (snapshot) => {
                    state.invoices = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}))
                        .sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    if(state.view === 'dashboard') app.renderInvoiceList();
                });
            },

            renderInvoiceList: () => {
                const tbody = document.getElementById('invoice-list');
                if(!tbody) return;
                tbody.innerHTML = state.invoices.map(inv => `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="p-4">
                            <div class="font-medium text-blue-600">${inv.invoiceNumber}</div>
                            <div class="text-xs text-gray-400 font-mono">${inv.securityCode}</div>
                        </td>
                        <td class="p-4">${inv.clientName}</td>
                        <td class="p-4">${Number(inv.totalAmount).toLocaleString()} Ks</td>
                        <td class="p-4 text-sm text-gray-500">${inv.createdAt?.seconds ? new Date(inv.createdAt.seconds*1000).toLocaleDateString() : '-'}</td>
                        <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${inv.status==='paid'?'bg-green-100 text-green-700':'bg-yellow-100 text-yellow-700'}">${inv.status.toUpperCase()}</span></td>
                        <td class="p-4 flex gap-2">
                            <button onclick="app.showVerify('${inv.id}')" class="p-2 text-gray-600 hover:bg-gray-200 rounded"><i data-lucide="printer" width="16"></i></button>
                            <button onclick="app.updateStatus('${inv.id}', '${inv.status}')" class="p-2 ${inv.status==='paid'?'text-orange-600':'text-green-600'} hover:bg-gray-100 rounded">
                                <i data-lucide="${inv.status==='paid'?'x-circle':'check-circle'}" width="16"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
                lucide.createIcons();
            },

            updateStatus: async (id, status) => {
                const newStatus = status === 'pending' ? 'paid' : 'pending';
                await updateDoc(doc(db, 'invoices', id), { 
                    status: newStatus, 
                    paidAt: newStatus === 'paid' ? serverTimestamp() : null 
                });
            },

            // --- Create Invoice Form ---
            renderCreateItems: () => {
                const container = document.getElementById('items-container');
                if(!container) return;
                
                // Clear existing items except label
                container.innerHTML = `<label class="block text-sm font-medium text-gray-700 mb-2">Items</label>`;
                
                state.items.forEach((item, idx) => {
                    const row = document.createElement('div');
                    row.className = "flex gap-2 mb-2";
                    row.innerHTML = `
                        <input placeholder="Desc" class="flex-grow border p-2 rounded" onchange="app.updateItem(${idx}, 'desc', this.value)" value="${item.desc}">
                        <input type="number" placeholder="Qty" class="w-20 border p-2 rounded" onchange="app.updateItem(${idx}, 'qty', this.value)" value="${item.qty}">
                        <input type="number" placeholder="Price" class="w-32 border p-2 rounded" onchange="app.updateItem(${idx}, 'price', this.value)" value="${item.price}">
                        <button type="button" onclick="app.removeItem(${idx})" class="text-red-500 p-2"><i data-lucide="x-circle" width="18"></i></button>
                    `;
                    container.appendChild(row);
                });
                lucide.createIcons();
                app.calcTotal();
            },

            updateItem: (idx, field, val) => {
                state.items[idx][field] = field === 'desc' ? val : Number(val);
                app.calcTotal();
            },

            addItem: () => {
                state.items.push({desc: '', price: 0, qty: 1});
                app.renderCreateItems();
            },

            removeItem: (idx) => {
                state.items.splice(idx, 1);
                app.renderCreateItems();
            },

            calcTotal: () => {
                const total = state.items.reduce((sum, i) => sum + (i.price * i.qty), 0);
                document.getElementById('create-total').innerText = total.toLocaleString();
                return total;
            },

            handleCreate: async (e) => {
                e.preventDefault();
                const clientName = document.getElementById('client-name').value;
                const total = app.calcTotal();
                
                try {
                    await addDoc(collection(db, 'invoices'), {
                        clientName,
                        items: state.items,
                        totalAmount: total,
                        createdAt: serverTimestamp(),
                        status: 'pending',
                        invoiceNumber: `INV-${Date.now().toString().slice(-6)}`,
                        securityCode: `SEC-${Math.random().toString(36).substring(2, 8).toUpperCase()}`,
                        createdBy: state.user.uid
                    });
                    app.setView('dashboard');
                } catch(e) { alert("Error creating invoice: " + e.message); }
            },

            // --- Verify & Print ---
            handleSearch: async (val) => {
                const queryVal = val || document.getElementById('search-input').value;
                if(!queryVal) return;

                app.setView('verify');
                const container = document.getElementById('verify-content');
                container.innerHTML = '<div class="p-10 text-blue-600">Searching...</div>';

                // Try finding
                let found = null;
                const q1 = query(collection(db, 'invoices'), where("invoiceNumber", "==", queryVal));
                const s1 = await getDocs(q1);
                if(!s1.empty) found = {id: s1.docs[0].id, ...s1.docs[0].data()};
                
                if(!found) {
                    const q2 = query(collection(db, 'invoices'), where("securityCode", "==", queryVal));
                    const s2 = await getDocs(q2);
                    if(!s2.empty) found = {id: s2.docs[0].id, ...s2.docs[0].data()};
                }

                if(found) app.renderInvoicePaper(found);
                else container.innerHTML = `
                    <div class="bg-white p-10 rounded-2xl shadow-lg text-center border-2 border-red-100">
                         <div class="text-red-500 mb-4 flex justify-center"><i data-lucide="x-circle" width="60" height="60"></i></div>
                         <h2 class="text-2xl font-bold text-gray-800 mb-2">Invoice မတွေ့ရှိပါ</h2>
                         <p class="text-gray-500">Invoice ID သို့မဟုတ် Security Code ကို ပြန်လည်စစ်ဆေးပါ။</p>
                    </div>`;
                lucide.createIcons();
            },

            showVerify: (id) => {
                const inv = state.invoices.find(i => i.id === id);
                app.setView('verify');
                app.renderInvoicePaper(inv);
            },

            renderInvoicePaper: (inv) => {
                state.currentInvoice = inv;
                const container = document.getElementById('verify-content');
                const verifyUrl = `${window.location.origin}${window.location.pathname}?code=${inv.securityCode}`;
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(verifyUrl)}`;

                container.innerHTML = `
                    <div id="invoice-paper" class="bg-white p-8 md:p-12 shadow-2xl rounded-sm w-full max-w-4xl text-gray-800 border relative min-h-[800px] flex flex-col justify-between">
                        <div>
                            <div class="flex justify-between items-start border-b pb-8 mb-8 z-10 relative">
                                <div>
                                    <h1 class="text-4xl font-extrabold text-blue-900 tracking-tight">INVOICE</h1>
                                    <p class="text-gray-500 mt-1"># ${inv.invoiceNumber}</p>
                                    <div class="mt-4 text-sm text-gray-600">
                                        <p class="font-bold">From:</p>
                                        <p>Your Company Name</p>
                                        <p>123 Merchant Road, Yangon</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <img src="${qrUrl}" crossOrigin="anonymous" class="w-24 h-24 mb-2 border p-1 inline-block">
                                    <p class="text-xs text-gray-400">Scan to Verify</p>
                                    <div class="mt-2 text-xs font-mono bg-gray-100 px-2 py-1 rounded inline-block">SEC: ${inv.securityCode}</div>
                                </div>
                            </div>
                            
                            <div class="flex justify-between mb-8">
                                <div>
                                    <p class="text-gray-500 text-sm font-bold uppercase">Bill To:</p>
                                    <h3 class="text-xl font-bold text-gray-800">${inv.clientName}</h3>
                                </div>
                                <div class="text-right">
                                    <p class="text-gray-500 text-sm font-bold uppercase">Date:</p>
                                    <p class="font-medium">${inv.createdAt?.seconds ? new Date(inv.createdAt.seconds*1000).toLocaleDateString() : 'Now'}</p>
                                </div>
                            </div>

                            <table class="w-full mb-8">
                                <thead class="bg-gray-100 text-gray-600 text-sm uppercase">
                                    <tr><th class="py-3 px-4 text-left">Desc</th><th class="py-3 px-4 text-right">Qty</th><th class="py-3 px-4 text-right">Price</th><th class="py-3 px-4 text-right">Total</th></tr>
                                </thead>
                                <tbody class="text-gray-700">
                                    ${inv.items.map(i => `
                                        <tr class="border-b border-gray-50">
                                            <td class="py-4 px-4">${i.desc}</td>
                                            <td class="py-4 px-4 text-right">${i.qty}</td>
                                            <td class="py-4 px-4 text-right">${i.price.toLocaleString()}</td>
                                            <td class="py-4 px-4 text-right font-medium">${(i.price*i.qty).toLocaleString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>

                        <div class="relative">
                            ${inv.status === 'paid' ? `
                                <div class="absolute right-64 top-0 transform -rotate-12 border-4 border-double border-red-600 text-red-600 px-6 py-2 font-black text-4xl opacity-80" style="-webkit-mask-image: url('https://s3-us-west-2.amazonaws.com/s.cdpn.io/8399/grunge.png');">
                                    PAID
                                </div>
                            ` : ''}
                            <div class="flex justify-end">
                                <div class="w-64">
                                    <div class="flex justify-between py-4 text-xl font-bold text-blue-900">
                                        <span>Total</span>
                                        <span>${Number(inv.totalAmount).toLocaleString()} Ks</span>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-12 pt-8 border-t text-center text-sm text-gray-400">
                                <p>Thank you for your business!</p>
                            </div>
                        </div>
                    </div>
                `;
            },

            downloadPDF: async () => {
                const element = document.getElementById('invoice-paper');
                const canvas = await html2canvas(element, { scale: 3, useCORS: true, windowWidth: 1024 });
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`Invoice-${state.currentInvoice.invoiceNumber}.pdf`);
            },

            backHome: () => {
                app.setView(state.isAdmin ? 'dashboard' : 'home');
            }
        };

        // Initialize
        window.app = app;
        app.init();
    </script>
</body>
</html>